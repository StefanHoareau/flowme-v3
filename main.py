"Vol d'altitude": {
        "id": 39,
        "famille_symbolique": "Élévation panoramique",
        "tension_dominante": "Élevée, surplombante",
        "mot_cle": "Élévation",
        "declencheurs": "Besoin de perspective globale",
        "posture_adaptative": "Prendre de la hauteur sans perdre le contact; Observer sans juger",
        "etats_compatibles": "13, 29, 34, 40, 42",
        "etats_sequenciels": "40, 42, 43, 58",
        "conseil_flowme": "Prendre de l'altitude permet de voir les connexions invisibles depuis le sol"
    },
    "Retour porteur": {
        "id": 40,
        "famille_symbolique": "Redescente enrichie",
        "tension_dominante": "Descendante, porteuse",
        "mot_cle": "Retour",
        "declencheurs": "Retour après élévation",
        "posture_adaptative": "Redescendre en gardant l'acquis; Intégrer l'expérience d'altitude",
        "etats_compatibles": "39, 42, 43, 56, 63",
        "etats_sequenciels": "43, 56, 63, 64",
        "conseil_flowme": "Le retour authentique ramène les trésors de l'altitude dans la vie ordinaire"
    },
    "Éveil d'empreinte": {
        "id": 41,
        "famille_symbolique": "Réveil de mémoire",
        "tension_dominante": "Éveillante, révélatrice",
        "mot_cle": "Éveil",
        "declencheurs": "Résonance avec une empreinte ancienne",
        "posture_adaptative": "Accueillir ce qui s'éveille; Ne pas forcer la mémoire",
        "etats_compatibles": "2, 24, 34, 48, 49",
        "etats_sequenciels": "42, 48, 49, 58",
        "conseil_flowme": "Certains éveils révèlent ce qui était déjà là, endormi"
    },
    "Précipitation du sens": {
        "id": 42,
        "famille_symbolique": "Cristallisation rapide",
        "tension_dominante": "Précipitante, condensante",
        "mot_cle": "Cristallisation",
        "declencheurs": "Compréhension soudaine",
        "posture_adaptative": "Laisser se cristalliser; Ne pas forcer la formulation",
        "etats_compatibles": "34, 39, 40, 43, 58",
        "etats_sequenciels": "43, 44, 58, 59",
        "conseil_flowme": "Quand le sens précipite, c'est que la solution était déjà présente"
    },
    "Retombée harmonique": {
        "id": 43,
        "famille_symbolique": "Résonance apaisée",
        "tension_dominante": "Apaisante, harmonisante",
        "mot_cle": "Harmonie",
        "declencheurs": "Résolution d'une tension",
        "posture_adaptative": "Accueillir l'apaisement; Laisser l'harmonie s'installer",
        "etats_compatibles": "40, 42, 44, 60, 61",
        "etats_sequenciels": "44, 60, 61, 64",
        "conseil_flowme": "Après l'intensité, la retombée harmonique permet l'intégration"
    },
    "Geste résonant": {
        "id": 44,
        "famille_symbolique": "Action accordée",
        "tension_dominante": "Accordée, juste",
        "mot_cle": "Justesse",
        "declencheurs": "Moment d'action juste",
        "posture_adaptative": "Agir dans la justesse; Laisser le geste naître de l'accord",
        "etats_compatibles": "8, 42, 43, 55, 56",
        "etats_sequenciels": "55, 56, 59, 63",
        "conseil_flowme": "Le geste résonant unit parfaitement l'intention et l'action"
    },
    "Disponibilité nue": {
        "id": 45,
        "famille_symbolique": "Ouverture totale",
        "tension_dominante": "Nue, disponible",
        "mot_cle": "Disponibilité",
        "declencheurs": "Lâcher-prise total",
        "posture_adaptative": "Être disponible sans attente; S'ouvrir sans se perdre",
        "etats_compatibles": "1, 11, 12, 20, 32",
        "etats_sequenciels": "52, 56, 61, 64",
        "conseil_flowme": "La disponibilité nue est l'état le plus réceptif et le plus créateur"
    },
    "Choc d'ombre": {
        "id": 46,
        "famille_symbolique": "Révélation brutale",
        "tension_dominante": "Choquante, révélatrice",
        "mot_cle": "Révélation",
        "declencheurs": "Découverte de ce qui était caché",
        "posture_adaptative": "Accueillir le choc; Ne pas fuir ce qui se révèle",
        "etats_compatibles": "24, 47, 49, 51, 53",
        "etats_sequenciels": "47, 49, 51, 53",
        "conseil_flowme": "Le choc d'ombre révèle ce que la lumière seule ne peut montrer"
    },
    "Dérive intérieure": {
        "id": 47,
        "famille_symbolique": "Errance interne",
        "tension_dominante": "Dérivante, flottante",
        "mot_cle": "Dérive",
        "declencheurs": "Perte de direction interne",
        "posture_adaptative": "Accepter la dérive; Faire confiance au courant profond",
        "etats_compatibles": "25, 33, 46, 48, 49",
        "etats_sequenciels": "48, 49, 52, 53",
        "conseil_flowme": "Parfois il faut dériver pour découvrir des rivages inconnus"
    },
    "Remontée de mémoire ancienne": {
        "id": 48,
        "famille_symbolique": "Résurgence du passé",
        "tension_dominante": "Remontante, révélatrice",
        "mot_cle": "Mémoire",
        "declencheurs": "Réactivation d'une mémoire profonde",
        "posture_adaptative": "Accueillir ce qui remonte; Ne pas rejuger le passé",
        "etats_compatibles": "9, 17, 25, 41, 47",
        "etats_sequenciels": "41, 49, 52, 58",
        "conseil_flowme": "Ce qui remonte du passé vient éclairer le présent"
    },
    "Résurgence incontrôlée": {
        "id": 49,
        "famille_symbolique": "Émergence chaotique",
        "tension_dominante": "Incontrôlée, débordante",
        "mot_cle": "Chaos",
        "declencheurs": "Débordement émotionnel ou mental",
        "posture_adaptative": "Ne pas lutter contre le chaos; Attendre que ça se pose",
        "etats_compatibles": "25, 33, 41, 46, 47",
        "etats_sequenciels": "50, 51, 52, 53",
        "conseil_flowme": "Même le chaos porte en lui les germes d'un nouvel ordre"
    },
    "Saturation et perte d'adhérence": {
        "id": 50,
        "famille_symbolique": "Surcharge critique",
        "tension_dominante": "Saturée, glissante",
        "mot_cle": "Saturation",
        "declencheurs": "Dépassement des capacités",
        "posture_adaptative": "Reconnaître la saturation; Alléger progressivement",
        "etats_compatibles": "26, 37, 38, 49, 51",
        "etats_sequenciels": "51, 52, 53, 54",
        "conseil_flowme": "La saturation signale qu'il est temps de simplifier et d'alléger"
    },
    "Fracture identitaire": {
        "id": 51,
        "famille_symbolique": "Rupture intérieure",
        "tension_dominante": "Fracturée, divisée",
        "mot_cle": "Fracture",
        "declencheurs": "Contradiction interne majeure",
        "posture_adaptative": "Accepter la fracture; Ne pas forcer l'unité prématurément",
        "etats_compatibles": "37, 38, 46, 49, 50",
        "etats_sequenciels": "52, 53, 54, 55",
        "conseil_flowme": "Parfois il faut se briser pour se reconstruire plus authentiquement"
    },
    "Silence matriciel": {
        "id": 52,
        "famille_symbolique": "Silence créateur",
        "tension_dominante": "Silencieuse, matricielle",
        "mot_cle": "Silence",
        "declencheurs": "Besoin de silence profond",
        "posture_adaptative": "Habiter le silence; Laisser naître de la vacuité",
        "etats_compatibles": "11, 19, 32, 45, 47",
        "etats_sequenciels": "53, 54, 55, 61",
        "conseil_flowme": "Le silence matriciel est le ventre où naissent les nouvelles formes"
    },
    "Tension du renouveau": {
        "id": 53,
        "famille_symbolique": "Poussée créatrice",
        "tension_dominante": "Tendue, créatrice",
        "mot_cle": "Renouveau",
        "declencheurs": "Élan de renouvellement",
        "posture_adaptative": "Accompagner la poussée; Ne pas précipiter la naissance",
        "etats_compatibles": "13, 29, 46, 49, 52",
        "etats_sequenciels": "54, 55, 56, 62",
        "conseil_flowme": "Le renouveau authentique naît de la destruction créatrice de l'ancien"
    },
    "Première inclinaison": {
        "id": 54,
        "famille_symbolique": "Mouvement naissant",
        "tension_dominante": "Naissante, orientée",
        "mot_cle": "Orientation",
        "declencheurs": "Première direction qui se dessine",
        "posture_adaptative": "Suivre l'inclinaison; Ne pas forcer la direction",
        "etats_compatibles": "50, 51, 52, 53, 55",
        "etats_sequenciels": "55, 56, 57, 63",
        "conseil_flowme": "La première inclinaison indique la direction naturelle du renouveau"
    },
    "Geste ténu": {
        "id": 55,
        "famille_symbolique": "Action délicate",
        "tension_dominante": "Ténue, précise",
        "mot_cle": "Délicatesse",
        "declencheurs": "Situation demandant finesse",
        "posture_adaptative": "Agir avec délicatesse; Doser finement l'intervention",
        "etats_compatibles": "23, 36, 44, 52, 54",
        "etats_sequenciels": "56, 57, 59, 63",
        "conseil_flowme": "Les gestes les plus ténus peuvent avoir les effets les plus profonds"
    },
    "Reprise accordée": {
        "id": 56,
        "famille_symbolique": "Recommencement harmonieux",
        "tension_dominante": "Accordée, renouvelée",
        "mot_cle": "Reprise",
        "declencheurs": "Nouveau départ possible",
        "posture_adaptative": "Reprendre en gardant l'acquis; Recommencer autrement",
        "etats_compatibles": "20, 28, 40, 44, 55",
        "etats_sequenciels": "57, 59, 63, 64",
        "conseil_flowme": "La reprise accordée unit l'expérience passée et l'élan nouveau"
    },
    "Dualité vivante": {
        "id": 57,
        "famille_symbolique": "Opposition créatrice",
        "tension_dominante": "Duelle, créatrice",
        "mot_cle": "Polarité",
        "declencheurs": "Tensions opposées à intégrer",
        "posture_adaptative": "Tenir les deux pôles; Ne pas choisir prématurément",
        "etats_compatibles": "21, 35, 54, 55, 58",
        "etats_sequenciels": "58, 59, 60, 63",
        "conseil_flowme": "La dualité vivante génère une dynamique créatrice"
    },
    "Clarté paradoxale": {
        "id": 58,
        "famille_symbolique": "Évidence contradictoire",
        "tension_dominante": "Claire, paradoxale",
        "mot_cle": "Paradoxe",
        "declencheurs": "Vérité paradoxale qui se révèle",
        "posture_adaptative": "Accepter le paradoxe; Ne pas forcer la logique",
        "etats_compatibles": "4, 14, 34, 42, 57",
        "etats_sequenciels": "59, 60, 61, 64",
        "conseil_flowme": "La clarté paradoxale révèle que la vérité dépasse souvent la logique"
    },
    "Inclusion active": {
        "id": 59,
        "famille_symbolique": "Intégration dynamique",
        "tension_dominante": "Inclusive, active",
        "mot_cle": "Inclusion",
        "declencheurs": "Besoin d'intégrer tous les éléments",
        "posture_adaptative": "Inclure sans diluer; Intégrer en gardant les spécificités",
        "etats_compatibles": "1, 6, 22, 36, 56",
        "etats_sequenciels": "60, 61, 63, 64",
        "conseil_flowme": "L'inclusion active crée une unité qui respecte la diversité"
    },
    "Rythme paradoxal": {
        "id": 60,
        "famille_symbolique": "Tempo complexe",
        "tension_dominante": "Rythmée, paradoxale",
        "mot_cle": "Rythme",
        "declencheurs": "Synchronisation complexe nécessaire",
        "posture_adaptative": "Suivre le rythme paradoxal; Accepter les tempos contradictoires",
        "etats_compatibles": "8, 18, 43, 57, 58",
        "etats_sequenciels": "61, 62, 63, 64",
        "conseil_flowme": "Le rythme paradoxal unit les contraires dans une danse unique"
    },
    "Plénitude tranquille": {
        "id": 61,
        "famille_symbolique": "Accomplissement serein",
        "tension_dominante": "Pleine, tranquille",
        "mot_cle": "Plénitude",
        "declencheurs": "Sentiment d'accomplissement",
        "posture_adaptative": "Habiter la plénitude; Goûter sans s'attacher",
        "etats_compatibles": "19, 28, 30, 32, 43",
        "etats_sequenciels": "62, 63, 64, 1",
        "conseil_flowme": "La plénitude tranquille est un repos dans l'être"
    },
    "Rayonnement discret": {
        "id": 62,
        "famille_symbolique": "Influence subtile",
        "tension_dominante": "Rayonnante, discrète",
        "mot_cle": "Rayonnement",
        "declencheurs": "Qualité qui veut se partager",
        "posture_adaptative": "Rayonner sans ostentation; Influencer par l'être",
        "etats_compatibles": "7, 16, 28, 29, 30",
        "etats_sequenciels": "63, 64, 1, 2",
        "conseil_flowme": "Le rayonnement discret touche sans forcer"
    },
    "Passage vivant": {
        "id": 63,
        "famille_symbolique": "Transition créatrice",
        "tension_dominante": "Transitoire, créatrice",
        "mot_cle": "Passage",
        "declencheurs": "Moment de transition",
        "posture_adaptative": "Habiter le passage; Ne pas précipiter l'arrivée",
        "etats_compatibles": "21, 35, 40, 56, 60",
        "etats_sequenciels": "64, 1, 2, 3",
        "conseil_flowme": "Le passage vivant transforme en reliant"
    },
    "Porte ouverte": {
        "id": 64,
        "famille_symbolique": "Ouverture totale",
        "tension_dominante": "Ouverte, accueillante",
        "mot_cle": "Ouverture",
        "declencheurs": "Disponibilité complète",
        "posture_adaptative": "Être une porte ouverte; Accueillir tout ce qui vient",
        "etats_compatibles": "1, 16, 22, 28, 30",
        "etats_sequenciels": "1, 2, 3, 16",
        "conseil_flowme": "Être porte ouverte, c'est offrir un passage entre les mondes"
    }
}

# ========== SYSTÈME DE MONITORING ==========
@dataclass
class ConversationMetrics:
    session_id: str
    user_id: str
    start_time: datetime
    end_time: Optional[datetime]
    message_count: int
    emotions_detected: list
    average_response_time: float

@dataclass
class SystemHealthMetrics:
    timestamp: datetime
    nocodb_status: bool
    mistral_status: bool
    response_times: Dict[str, float]
    error_count: int
    active_sessions: int

class FlowMeAnalytics:
    def __init__(self):
        self.conversations: Dict[str, ConversationMetrics] = {}
        self.health_history = []
        self.emotion_stats = Counter()
        self.error_log = []
        self.system_start_time = datetime.now()
        
    def start_conversation(self, session_id: str, user_id: str = "anonymous"):
        self.conversations[session_id] = ConversationMetrics(
            session_id=session_id,
            user_id=user_id,
            start_time=datetime.now(),
            end_time=None,
            message_count=0,
            emotions_detected=[],
            average_response_time=0.0
        )
        
    def log_message(self, session_id: str, emotion: str, response_time: float):
        if session_id in self.conversations:
            conv = self.conversations[session_id]
            conv.message_count += 1
            conv.emotions_detected.append(emotion)
            
            current_avg = conv.average_response_time
            conv.average_response_time = (current_avg * (conv.message_count - 1) + response_time) / conv.message_count
            
            self.emotion_stats[emotion] += 1
    
    def log_system_health(self, nocodb_status: bool, mistral_status: bool, 
                         response_times: Dict[str, float], error_count: int):
        health = SystemHealthMetrics(
            timestamp=datetime.now(),
            nocodb_status=nocodb_status,
            mistral_status=mistral_status,
            response_times=response_times,
            error_count=error_count,
            active_sessions=len([c for c in self.conversations.values() if c.end_time is None])
        )
        
        self.health_history.append(health)
        
        # Garder seulement les 24 dernières heures
        cutoff = datetime.now() - timedelta(hours=24)
        self.health_history = [h for h in self.health_history if h.timestamp > cutoff]
    
    def log_error(self, error_type: str, error_message: str, session_id: str = None):
        self.error_log.append({
            'timestamp': datetime.now(),
            'type': error_type,
            'message': error_message,
            'session_id': session_id
        })
        
        if len(self.error_log) > 100:
            self.error_log = self.error_log[-100:]
    
    def get_analytics_summary(self) -> Dict[str, Any]:
        now = datetime.now()
        uptime = (now - self.system_start_time).total_seconds()
        
        # Calculer l'uptime système
        system_uptime = 100.0
        if self.health_history:
            total_checks = len(self.health_history)
            successful = sum(1 for h in self.health_history if h.nocodb_status and h.mistral_status)
            system_uptime = (successful / total_checks) * 100 if total_checks > 0 else 100.0
        
        # Temps de réponse moyen
        avg_response_time = 0.0
        if self.conversations:
            response_times = [c.average_response_time for c in self.conversations.values() if c.average_response_time > 0]
            avg_response_time = sum(response_times) / len(response_times) if response_times else 0.0
        
        return {
            "uptime_seconds": uptime,
            "total_conversations": len(self.conversations),
            "active_conversations": len([c for c in self.conversations.values() if c.end_time is None]),
            "total_messages": sum(c.message_count for c in self.conversations.values()),
            "system_uptime_percent": round(system_uptime, 2),
            "average_response_time": round(avg_response_time, 2),
            "top_emotions": dict(self.emotion_stats.most_common(5)),
            "recent_errors": len([e for e in self.error_log if e['timestamp'] > now - timedelta(hours=1)])
        }

# ========== APPLICATION PRINCIPALE ==========

app = FastAPI(title="FlowMe v3 - 64 États", version="3.1.0")

# Variables d'environnement
MISTRAL_API_KEY = os.getenv("MISTRAL_API_KEY")
NOCODB_URL = os.getenv("NOCODB_URL", "https://app.nocodb.com")
NOCODB_API_KEY = os.getenv("NOCODB_API_KEY")
NOCODB_STATES_TABLE_ID = os.getenv("NOCODB_STATES_TABLE_ID", "mpcze1flcb4x64x")
NOCODB_REACTIONS_TABLE_ID = os.getenv("NOCODB_REACTIONS_TABLE_ID", "m8lwhj640ohzg7m")

class ChatMessage(BaseModel):
    message: str
    user_id: Optional[str] = "anonymous"

class Enhanced64StatesDetection:
    def __init__(self, source: str = "integrated"):
        self.states = FLOWME_64_STATES
        self.source = source
        # Stockage des données NocoDB additionnelles
        self.nocodb_additional_data = {}
        logger.info(f"✅ FlowMe initialisé avec 64 états intégrés - Source: {source}")
    
    def add_nocodb_data(self, nocodb_data: Dict[str, Any]):
        """Ajoute les données NocoDB aux 64 états de base"""
        self.nocodb_additional_data = nocodb_data
        logger.info(f"📊 Données NocoDB additionnelles ajoutées: {len(nocodb_data)} états")
    
    def detect_emotion(self, text: str) -> str:
        """Détection d'émotion sophistiquée sur les 64 états"""
        text_lower = text.lower()
        
        # Scoring pour tous les 64 états basé sur leurs caractéristiques
        emotion_scores = {}
        
        for state_name, state_data in self.states.items():
            score = 0
            
            # Analyse basée sur le mot-clé principal
            if state_data["mot_cle"].lower() in text_lower:
                score += 5
            
            # Analyse des déclencheurs
            declencheurs = state_data["declencheurs"].lower()
            declencheur_words = declencheurs.split()
            for word in declencheur_words:
                if len(word) > 3 and word in text_lower:
                    score += 3
            
            # Analyse de la famille symbolique
            famille_words = state_data["famille_symbolique"].lower().split()
            for word in famille_words:
                if len(word) > 3 and word in text_lower:
                    score += 2
            
            # Analyse de la tension dominante
            tension_words = state_data["tension_dominante"].lower().split()
            for word in tension_words:
                if len(word) > 3 and word in text_lower:
                    score += 2
            
            # Mots-clés spéciaux par catégories d'états
            if "joie" in text_lower or "heur" in text_lower or "content" in text_lower:
                if "émerveille" in state_name.lower() or "rayonne" in state_name.lower():
                    score += 4
            
            if "trist" in text_lower or "mélan" in text_lower or "sombre" in text_lower:
                if "silence" in state_name.lower() or "contempla" in state_name.lower():
                    score += 4
            
            if "peur" in text_lower or "anxie" in text_lower or "stress" in text_lower:
                if "vigilance" in state_name.lower() or "prudence" in state_name.lower():
                    score += 4
            
            if "colère" in text_lower or "énervé" in text_lower or "frustré" in text_lower:
                if "tension" in state_name.lower() or "excessive" in state_name.lower():
                    score += 4
            
            if "confusion" in text_lower or "perdu" in text_lower or "comprend pas" in text_lower:
                if "perplexité" in state_name.lower() or "altération" in state_name.lower():
                    score += 4
            
            if "émerveil" in text_lower or "fascin" in text_lower or "découvr" in text_lower:
                if "éveil" in state_name.lower() or "émerveillement" in state_name.lower():
                    score += 4
            
            if score > 0:
                emotion_scores[state_name] = score
        
        # Retourner l'état avec le score le plus élevé
        if emotion_scores:
            return max(emotion_scores, key=emotion_scores.get)
        
        return "Présence"  # Défaut
    
    def get_state_for_mistral(self, detected_state: str) -> Dict[str, Any]:
        """Récupère les données complètes d'un état pour Mistral"""
        if detected_state in self.states:
            state_data = self.states[detected_state].copy()
            
            # Ajouter les données NocoDB si disponibles
            if detected_state in self.nocodb_additional_data:
                state_data.update(self.nocodb_additional_data[detected_state])
            
            return state_data
        
        return self.states.get("Présence", {})

# Instances globales
flowme_states = None
analytics = FlowMeAnalytics()

async def load_complete_states():
    global flowme_states
    
    logger.info("🔍 Chargement du système FlowMe complet...")
    
    # Initialiser avec les 64 états intégrés
    flowme_states = Enhanced64StatesDetection("64_états_intégrés")
    
    nocodb_status = False
    
    # Essayer de charger des données additionnelles depuis NocoDB
    if NOCODB_API_KEY and NOCODB_STATES_TABLE_ID:
        try:
            headers = {"accept": "application/json", "xc-token": NOCODB_API_KEY}
            url = f"{NOCODB_URL}/api/v2/tables/{NOCODB_STATES_TABLE_ID}/records"
            
            async with httpx.AsyncClient(timeout=10.0) as client:
                response = await client.get(url, headers=headers)
                
                if response.status_code == 200:
                    data = response.json()
                    records = data.get("list", []) if isinstance(data, dict) else data
                    
                    if records:
                        nocodb_additional = {}
                        
                        for record in records:
                            if isinstance(record, dict):
                                name = record.get("Nom_État")
                                if name and name in FLOWME_64_STATES:
                                    # Données additionnelles NocoDB
                                    nocodb_additional[name] = {
                                        "nocodb_id": record.get("ID_État", ""),
                                        "nocodb_data": record
                                    }
                        
                        if nocodb_additional:
                            flowme_states.add_nocodb_data(nocodb_additional)
                            nocodb_status = True
                            logger.info(f"✅ Données NocoDB additionnelles ajoutées pour {len(nocodb_additional)} états")
                        
        except Exception as e:
            logger.warning(f"⚠️ Erreur NocoDB (non critique): {e}")
            analytics.log_error("nocodb_additional", str(e))
    
    logger.info(f"🎯 Système FlowMe COMPLET initialisé:")
    logger.info(f"   📊 64 états intégrés disponibles")
    logger.info(f"   🔗 NocoDB: {'✅ Connecté' if nocodb_status else '⚠️ Non disponible'}")
    logger.info(f"   🤖 Mistral a accès aux 64 états complets")
    
    return nocodb_status

async def save_to_nocodb(user_message: str, ai_response: str, detected_state: str, user_id: str):
    if not NOCODB_API_KEY:
        return False
    
    try:
        headers = {
            "accept": "application/json",
            "Content-Type": "application/json",
            "xc-token": NOCODB_API_KEY
        }
        
        url = f"{NOCODB_URL}/api/v2/tables/{NOCODB_REACTIONS_TABLE_ID}/records"
        payload = {
            "etat_nom": detected_state,
            "tension_dominante": ai_response[:1000],
            "famille_symbolique": user_message[:500],
            "session_id": user_id,
            "timestamp": datetime.now().isoformat()
        }
        
        async with httpx.AsyncClient(timeout=8.0) as client:
            response = await client.post(url, headers=headers, json=payload)
            return response.status_code in [200, 201]
    except Exception as e:
        analytics.log_error("nocodb_save", str(e))
        return False

async def generate_mistral_response(message: str, detected_state: str) -> tuple[str, bool]:
    mistral_status = False
    
    if not MISTRAL_API_KEY:
        return f"Je comprends que vous ressentez '{detected_state}'. Comment puis-je vous accompagner ?", mistral_status
    
    try:
        # RÉCUPÉRER LES DONNÉES COMPLÈTES de l'état (64 états)
        state_data = flowme_states.get_state_for_mistral(detected_state)
        
        # Construire le prompt enrichi avec TOUTES les données des 64 états
        system_prompt = f"""Tu es FlowMe, un compagnon IA empathique spécialisé dans l'accompagnement émotionnel basé sur 64 états de conscience spécifiques.

ÉTAT DÉTECTÉ: {detected_state} (ID: {state_data.get('id', '')})

DONNÉES COMPLÈTES DE L'ÉTAT:
- Famille symbolique: {state_data.get('famille_symbolique', '')}
- Tension dominante: {state_data.get('tension_dominante', '')}
- Mot-clé: {state_data.get('mot_cle', '')}
- Déclencheurs: {state_data.get('declencheurs', '')}
- Posture adaptative: {state_data.get('posture_adaptative', '')}
- États compatibles: {state_data.get('etats_compatibles', '')}
- États séquenciels: {state_data.get('etats_sequenciels', '')}
- Conseil FlowMe: {state_data.get('conseil_flowme', '')}

INSTRUCTIONS POUR MISTRAL:
1. Utilise la "Famille symbolique" pour créer une atmosphère poétique appropriée
2. Utilise la "Tension dominante" pour comprendre l'énergie spécifique de l'état
3. Intègre le "Conseil FlowMe" de manière naturelle et sage
4. Propose la "Posture adaptative" comme guidance pratique concrète
5. Valide l'expérience en référence aux "Déclencheurs"
6. Si approprié, mentionne discrètement les "États compatibles" ou "séquenciels"
7. Reste empathique, sage et bienveillant (max 150 mots)
8. Parle comme un guide expérimenté qui connaît intimement ces 64 états

Message de l'utilisateur: {message}"""

        headers = {
            "Authorization": f"Bearer {MISTRAL_API_KEY}",
            "Content-Type": "application/json"
        }
        
        payload = {
            "model": "mistral-small-latest",
            "messages": [
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": message}
            ],
            "temperature": 0.7,
            "max_tokens": 200
        }
        
        async with httpx.AsyncClient(timeout=15.0) as client:
            response = await client.post(
                "https://api.mistral.ai/v1/chat/completions",
                headers=headers,
                json=payload
            )
            
            if response.status_code == 200:
                result = response.json()
                mistral_status = True
                return result["choices"][0]["message"]["content"].strip(), mistral_status
                
    except Exception as e:
        analytics.log_error("mistral_api", str(e))
        logger.error(f"Erreur Mistral API: {e}")
    
    return f"Je comprends votre état de '{detected_state}'. Parlons de ce qui vous préoccupe.", mistral_status

@app.on_event("startup")
async def startup_event():
    nocodb_status = await load_complete_states()
    
    # Log de la santé initiale du système
    analytics.log_system_health(
        nocodb_status=nocodb_status,
        mistral_status=bool(MISTRAL_API_KEY),
        response_times={},
        error_count=0
    )
    
    logger.info("🚀 FlowMe v3 démarré avec 64 ÉTATS COMPLETS + intégration Mistral")

@app.get("/", response_class=HTMLResponse)
async def home():
    return HTMLResponse("""
    <!DOCTYPE html>
    <html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>FlowMe v3 - 64 États Complets</title>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
            .container { background: rgba(255,255,255,0.95); border-radius: 20px; padding: 40px; max-width: 700px; width: 100%; }
            h1 { text-align: center; color: #333; margin-bottom: 10px; }
            .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-style: italic; }
            .chat { background: #f8f9fa; border-radius: 15px; padding: 20px; margin-bottom: 20px; min-height: 350px; overflow-y: auto; }
            .message { margin-bottom: 15px; padding: 15px; border-radius: 15px; }
            .user-message { background: linear-gradient(135deg, #667eea, #764ba2); color: white; margin-left: 15%; }
            .ai-message { background: white; border: 2px solid #e9ecef; margin-right: 15%; }
            .input-container { display: flex; gap: 10px; }
            input { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 10px; }
            button { padding: 12px 24px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 10px; cursor: pointer; }
            button:hover { transform: translateY(-1px); }
            .status { text-align: center; margin-top: 15px; font-size: 0.9em; color: #666; }
            .analytics-link { 
                position: fixed; 
                top: 20px; 
                right: 20px; 
                background: rgba(255,255,255,0.9); 
                padding: 10px 15px; 
                border-radius: 10px; 
                text-decoration: none; 
                color: #667eea; 
                font-weight: bold;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            }
            .analytics-link:hover { background: #667eea; color: white; }
            .states-status {
                position: fixed;
                top: 20px;
                left: 20px;
                background: linear-gradient(135deg, #28a745, #20c997);
                padding: 8px 12px;
                border-radius: 8px;
                color: white;
                font-size: 0.8em;
                font-weight: bold;
            }
            .debug-link {
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: rgba(108, 117, 125, 0.9);
                padding: 8px 12px;
                border-radius: 8px;
                text-decoration: none;
                color: white;
                font-size: 0.8em;
            }
            .states-link {
                position: fixed;
                bottom: 20px;
                left: 20px;
                background: rgba(102, 126, 234, 0.9);
                padding: 8px 12px;
                border-radius: 8px;
                text-decoration: none;
                color: white;
                font-size: 0.8em;
            }
        </style>
    </head>
    <body>
        <div class="states-status">🎯 64 États Intégrés</div>
        <a href="/analytics/dashboard" class="analytics-link" target="_blank">📊 Analytics</a>
        <a href="/debug/states-64" class="debug-link" target="_blank">🔍 Debug 64</a>
        <a href="/states/list" class="states-link" target="_blank">📋 64 États</a>
        
        <div class="container">
            <h1>🌊💙 FlowMe v3 COMPLET</h1>
            <p class="subtitle">64 États de Conscience • IA Mistral Intégrée</p>
            <div class="chat" id="chat">
                <div class="message ai-message">
                    <strong>FlowMe:</strong> Bonjour ! Je suis maintenant équipé des 64 états de conscience complets : de la "Présence" au "Rayonnement discret", en passant par la "Clarté paradoxale" et le "Silence matriciel". Comment vous sentez-vous aujourd'hui ?
                </div>
            </div>
            <div class="input-container">
                <input type="text" id="input" placeholder="Exprimez votre état intérieur..." maxlength="500">
                <button onclick="sendMessage()">Envoyer</button>
            </div>
            <div class="status" id="status">FlowMe v3 COMPLET - 64 États Disponibles</div>
        </div>
        
        <script>
            let isProcessing = false;
            
            async function sendMessage() {
                if (isProcessing) return;
                const input = document.getElementById('input');
                const message = input.value.trim();
                if (!message) return;
                
                isProcessing = true;
                document.getElementById('status').textContent = 'FlowMe analyse parmi 64 états...';
                
                addMessage(message, 'user');
                input.value = '';
                
                try {
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({message: message})
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        addMessage(data.response, 'ai');
                        const responseTime = data.response_time ? ` (${data.response_time}s)` : '';
                        document.getElementById('status').textContent = `État détecté: "${data.detected_state}" • 64 États${responseTime}`;
                    } else {
                        addMessage('Erreur de connexion.', 'ai');
                    }
                } catch (error) {
                    addMessage('Erreur de connexion.', 'ai');
                } finally {
                    isProcessing = false;
                }
            }
            
            function addMessage(text, sender) {
                const chat = document.getElementById('chat');
                const div = document.createElement('div');
                div.className = `message ${sender}-message`;
                div.innerHTML = `<strong>${sender === 'user' ? 'Vous' : 'FlowMe'}:</strong> ${text}`;
                chat.appendChild(div);
                chat.scrollTop = chat.scrollHeight;
            }
            
            document.getElementById('input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });
        </script>
    </body>
    </html>
    """)

@app.post("/chat")
async def chat_endpoint(chat_message: ChatMessage):
    start_time = time.time()
    session_id = chat_message.user_id or "anonymous"
    
    try:
        if not flowme_states:
            raise HTTPException(status_code=503, detail="Service non disponible")
        
        # Démarrer la conversation si nouvelle
        if session_id not in analytics.conversations:
            analytics.start_conversation(session_id, chat_message.user_id)
        
        clean_message = chat_message.message.strip()[:500]
        
        # Détection d'émotion sur les 64 états
        detected_state = flowme_states.detect_emotion(clean_message)
        
        # Génération de réponse avec données des 64 états
        ai_response, mistral_status = await generate_mistral_response(clean_message, detected_state)
        
        # Calculer le temps de réponse
        response_time = time.time() - start_time
        
        # Log des métriques
        analytics.log_message(session_id, detected_state, response_time)
        
        # Log de la santé système
        analytics.log_system_health(
            nocodb_status=True,  # Toujours true car on a les 64 états intégrés
            mistral_status=mistral_status,
            response_times={"chat": response_time},
            error_count=0
        )
        
        # Sauvegarde asynchrone
        await save_to_nocodb(clean_message, ai_response, detected_state, session_id)
        
        return JSONResponse({
            "response": ai_response,
            "detected_state": detected_state,
            "source": "64_états_intégrés",
            "timestamp": datetime.now().isoformat(),
            "response_time": round(response_time, 2),
            "total_states_available": 64,
            "state_id": flowme_states.states[detected_state]["id"] if detected_state in flowme_states.states else None
        })
        
    except Exception as e:
        analytics.log_error("chat_error", str(e), session_id)
        logger.error(f"Erreur chat: {e}")
        return JSONResponse({
            "response": "Je rencontre une difficulté technique. Pouvez-vous réessayer ?",
            "detected_state": "Présence",
            "error": "Service indisponible"
        }, status_code=500)

# ========== ENDPOINTS SPÉCIAUX 64 ÉTATS ==========

@app.get("/states/list")
async def list_all_states():
    """Liste complète des 64 états"""
    if not flowme_states:
        return JSONResponse({"error": "FlowMe non initialisé"})
    
    states_list = []
    for name, data in flowme_states.states.items():
        states_list.append({
            "id": data["id"],
            "nom": name,
            "famille_symbolique": data["famille_symbolique"],
            "tension_dominante": data["tension_dominante"],
            "mot_cle": data["mot_cle"],
            "conseil_flowme": data["conseil_flowme"]
        })
    
    # Trier par ID
    states_list.sort(key=lambda x: x["id"])
    
    return JSONResponse({
        "total_states": len(states_list),
        "states": states_list
    })

@app.get("/states/{state_name}")
async def get_state_details(state_name: str):
    """Détails complets d'un état spécifique"""
    if not flowme_states:
        return JSONResponse({"error": "FlowMe non initialisé"})
    
    if state_name not in flowme_states.states:
        return JSONResponse({"error": f"État '{state_name}' non trouvé"})
    
    return JSONResponse({
        "state_name": state_name,
        "data": flowme_states.states[state_name]
    })

@app.get("/debug/states-64")
async def debug_64_states():
    """Debug complet du système 64 états"""
    if not flowme_states:
        return JSONResponse({"error": "FlowMe non initialisé"})
    
    debug_info = {
        "system_status": "64 états intégrés",
        "total_states": len(flowme_states.states),
        "source": flowme_states.source,
        "nocodb_additional": len(flowme_states.nocodb_additional_data),
        "states_categories": {}
    }
    
    # Analyser les catégories d'états
    for name, data in flowme_states.states.items():
        tension = data["tension_dominante"]
        if "élevée" in tension or "haute" in tension:
            category = "Haute_intensité"
        elif "latente" in tension or "subtile" in tension:
            category = "Subtile"
        elif "créat" in tension or "génér" in tension:
            category = "Créative"
        elif "tranquille" in tension or "apais" in tension:
            category = "Apaisante"
        else:
            category = "Autre"
        
        if category not in debug_info["states_categories"]:
            debug_info["states_categories"][category] = []
        debug_info["states_categories"][category].append(name)
    
    # Exemples d'états par ID
    debug_info["sample_states"] = {
        "premiers_etats": {str(i): list(flowme_states.states.keys())[i-1] for i in range(1, 6)},
        "etats_complexes": {str(i): list(flowme_states.states.keys())[i-1] for i in range(60, 65)},
        "etats_centraux": {str(i): list(flowme_states.states.keys())[i-1] for i in range(30, 35)}
    }
    
    return JSONResponse(debug_info)

# ========== ENDPOINTS ANALYTICS AMÉLIORÉS ==========

@app.get("/analytics")
async def get_analytics():
    """Dashboard d'analytics avec 64 états"""
    summary = analytics.get_analytics_summary()
    
    # Ajouter des métriques spécifiques aux 64 états
    recent_conversations = []
    for conv in sorted(analytics.conversations.values(), key=lambda x: x.start_time, reverse=True)[:10]:
        recent_conversations.append({
            "session_id": conv.session_id,
            "start_time": conv.start_time.isoformat(),
            "message_count": conv.message_count,
            "emotions": conv.emotions_detected[-3:] if conv.emotions_detected else [],
            "avg_response_time": round(conv.average_response_time, 2)
        })
    
    summary["recent_conversations"] = recent_conversations
    summary["error_log"] = [
        {
            "timestamp": err["timestamp"].isoformat(),
            "type": err["type"],
            "message": err["message"][:100]
        }
        for err in analytics.error_log[-10:]
    ]
    
    # Informations spécifiques aux 64 états
    summary["flowme_64_system"] = {
        "total_states": 64,
        "integrated_states": len(flowme_states.states) if flowme_states else 0,
        "nocodb_additional": len(flowme_states.nocodb_additional_data) if flowme_states else 0,
        "system_version": "3.1.0_64_états_complets",
        "detection_sophistication": "avancée",
        "mistral_integration": "complète_64_états"
    }
    
    return JSONResponse(summary)

@app.get("/analytics/dashboard")
async def analytics_dashboard():
    """Dashboard pour le système 64 états"""
    return HTMLResponse("""
    <!DOCTYPE html>
    <html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>FlowMe Analytics - 64 États Complets</title>
        <style>
            body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
            .container { max-width: 1200px; margin: 0 auto; }
            .card { background: white; border-radius: 10px; padding: 20px; margin: 15px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
            .metric { display: inline-block; margin: 10px 20px 10px 0; }
            .metric-value { font-size: 2em; font-weight: bold; color: #667eea; }
            .metric-label { color: #666; font-size: 0.9em; }
            .success { color: #28a745; }
            h1, h2 { color: #333; }
            .refresh-btn { 
                background: #667eea; 
                color: white; 
                border: none; 
                padding: 10px 20px; 
                border-radius: 5px; 
                cursor: pointer; 
                margin-bottom: 20px;
            }
            .refresh-btn:hover { background: #5a6fd8; }
            .system-status {
                background: linear-gradient(135deg, #28a745, #20c997);
                color: white;
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 20px;
                text-align: center;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>📊 FlowMe v3 - Analytics Dashboard 64 États</h1>
            <button class="refresh-btn" onclick="loadAnalytics()">🔄 Actualiser</button>
            
            <div class="card system-status">
                <h2>🎯 Système FlowMe 64 États COMPLETS</h2>
                <div id="systemStatus">Chargement...</div>
            </div>
            
            <div class="card">
                <h2>📈 Métriques Générales</h2>
                <div id="generalMetrics">Chargement...</div>
            </div>
            
            <div class="card">
                <h2>💭 États Détectés (sur 64)</h2>
                <div id="emotionMetrics">Chargement...</div>
            </div>
            
            <div class="card">
                <h2>💬 Conversations Récentes</h2>
                <div id="conversationMetrics">Chargement...</div>
            </div>
        </div>
        
        <script>
            async function loadAnalytics() {
                try {
                    const response = await fetch('/analytics');
                    const data = await response.json();
                    
                    // Statut système 64 états
                    const system = data.flowme_64_system;
                    document.getElementById('systemStatus').innerHTML = `
                        <p><strong>✅ ${system.total_states} États Intégrés Disponibles</strong></p>
                        <p>🤖 Mistral AI avec détection sophistiquée sur 64 états</p>
                        <p>📊 Version: ${system.system_version}</p>
                        <p>🎯 États NocoDB additionnels: ${system.nocodb_additional}</p>
                    `;
                    
                    // Métriques générales
                    document.getElementById('generalMetrics').innerHTML = `
                        <div class="metric">
                            <div class="metric-value">${data.total_conversations}</div>
                            <div class="metric-label">Conversations totales</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value success">${data.total_messages}</div>
                            <div class="metric-label">Messages analysés</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${data.average_response_time}s</div>
                            <div class="metric-label">Temps de réponse</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value success">64</div>
                            <div class="metric-label">États disponibles</div>
                        </div>
                    `;
                    
                    // États détectés
                    let emotionsHtml = '';
                    for (const [emotion, count] of Object.entries(data.top_emotions)) {
                        emotionsHtml += `
                            <div class="metric">
                                <div class="metric-value">${count}</div>
                                <div class="metric-label">${emotion}</div>
                            </div>
                        `;
                    }
                    document.getElementById('emotionMetrics').innerHTML = emotionsHtml || 'Aucun état détecté encore';
                    
                    // Conversations récentes
                    let conversationsHtml = '<ul>';
                    data.recent_conversations.forEach(conv => {
                        conversationsHtml += `
                            <li>
                                <strong>${conv.session_id}</strong> - 
                                ${conv.message_count} messages - 
                                États: ${conv.emotions.join(', ') || 'Aucun'} - 
                                Temps: ${conv.avg_response_time}s
                            </li>
                        `;
                    });
                    conversationsHtml += '</ul>';
                    document.getElementById('conversationMetrics').innerHTML = conversationsHtml;
                    
                } catch (error) {
                    console.error('Erreur:', error);
                }
            }
            
            loadAnalytics();
            setInterval(loadAnalytics, 30000);
        </script>
    </body>
    </html>
    """)

@app.get("/health")
async def health_check():
    """Health check du système 64 états"""
    summary = analytics.get_analytics_summary()
    
    return JSONResponse({
        "status": "healthy",
        "version": "3.1.0-64-states-complete",
        "states_count": 64,
        "states_integrated": len(flowme_states.states) if flowme_states else 0,
        "source": "64_états_intégrés_complets",
        "timestamp": datetime.now().isoformat(),
        "uptime_seconds": summary["uptime_seconds"],
        "system_uptime_percent": summary["system_uptime_percent"],
        "active_conversations": summary["active_conversations"],
        "average_response_time": summary["average_response_time"],
        "recent_errors": summary["recent_errors"],
        "mistral_has_64_states": True,
        "detection_sophistication": "avancée_64_états"
    })

if __name__ == "__main__":
    port = int(os.getenv("PORT", 8000))
    uvicorn.run(app, host="0.0.0.0", port=port)import os
import json
import httpx
import logging
import time
from fastapi import FastAPI, HTTPException
from fastapi.responses import HTMLResponse, JSONResponse
from pydantic import BaseModel
from typing import Dict, Any, Optional
import uvicorn
from datetime import datetime, timedelta
from collections import defaultdict, Counter
from dataclasses import dataclass, asdict

# Configuration du logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# ========== 64 ÉTATS COMPLETS INTÉGRÉS ==========
FLOWME_64_STATES = {
    "Présence": {
        "id": 1,
        "famille_symbolique": "Écoute subtile",
        "tension_dominante": "Latente, intérieure",
        "mot_cle": "Perception",
        "declencheurs": "Léger malaise",
        "posture_adaptative": "Suspendre tout traitement analytique immédiat; Observer les signaux faibles",
        "etats_compatibles": "8, 32, 45, 59, 64",
        "etats_sequenciels": "2, 8, 10, 11",
        "conseil_flowme": "Quand tout semble brumeux, c'est dans le silence que la clarté peut émerger"
    },
    "Éveil": {
        "id": 2,
        "famille_symbolique": "Fraîcheur neuve",
        "tension_dominante": "Émergente, vivifiante",
        "mot_cle": "Découverte",
        "declencheurs": "Signal nouveau, révélation",
        "posture_adaptative": "Accueillir sans précipitation; Laisser l'information se déployer",
        "etats_compatibles": "1, 3, 16, 29, 41",
        "etats_sequenciels": "3, 4, 14, 16",
        "conseil_flowme": "Ce qui naît en vous cherche à être reconnu, pas analysé"
    },
    "Curiosité": {
        "id": 3,
        "famille_symbolique": "Élan vers l'inconnu",
        "tension_dominante": "Orientée, exploratrice",
        "mot_cle": "Investigation",
        "declencheurs": "Question émergente, mystère",
        "posture_adaptative": "Suivre l'élan sans forcer; Questionner avec délicatesse",
        "etats_compatibles": "2, 9, 17, 26, 34",
        "etats_sequenciels": "4, 5, 13, 17",
        "conseil_flowme": "La vraie curiosité ne cherche pas de réponses immédiates, elle s'émerveille du questionnement"
    },
    "Étonnement": {
        "id": 4,
        "famille_symbolique": "Suspension admirative",
        "tension_dominante": "Ouverte, réceptive",
        "mot_cle": "Surprise",
        "declencheurs": "Inattendu, révélation soudaine",
        "posture_adaptative": "Rester dans la surprise; Ne pas immédiatement comprendre",
        "etats_compatibles": "2, 3, 16, 24, 58",
        "etats_sequenciels": "5, 14, 16, 24",
        "conseil_flowme": "L'étonnement est la porte d'entrée vers une compréhension plus vaste"
    },
    "Analyse": {
        "id": 5,
        "famille_symbolique": "Dissection lucide",
        "tension_dominante": "Focalisée, pénétrante",
        "mot_cle": "Discernement",
        "declencheurs": "Complexité à démêler",
        "posture_adaptative": "Analyser sans perdre la vue d'ensemble; Garder la nuance",
        "etats_compatibles": "6, 15, 23, 31, 58",
        "etats_sequenciels": "6, 14, 15, 23",
        "conseil_flowme": "Analyser c'est éclairer, pas réduire"
    },
    "Synthèse": {
        "id": 6,
        "famille_symbolique": "Unification créatrice",
        "tension_dominante": "Rassembleuse, intégrative",
        "mot_cle": "Cohérence",
        "declencheurs": "Éléments dispersés à relier",
        "posture_adaptative": "Laisser émerger les connexions; Ne pas forcer l'unification",
        "etats_compatibles": "5, 7, 22, 29, 59",
        "etats_sequenciels": "7, 14, 22, 30",
        "conseil_flowme": "La synthèse authentique naît d'elle-même quand les éléments sont mûrs"
    },
    "Intuition": {
        "id": 7,
        "famille_symbolique": "Connaissance directe",
        "tension_dominante": "Spontanée, révélatrice",
        "mot_cle": "Évidence",
        "declencheurs": "Savoir sans savoir pourquoi",
        "posture_adaptative": "Faire confiance à ce qui se présente; Ne pas justifier immédiatement",
        "etats_compatibles": "6, 8, 14, 29, 62",
        "etats_sequenciels": "8, 14, 30, 62",
        "conseil_flowme": "L'intuition parle d'abord, la raison comprend ensuite"
    },
    "Résonance": {
        "id": 8,
        "famille_symbolique": "Vibration accordée",
        "tension_dominante": "Harmonisante, sympathique",
        "mot_cle": "Accord",
        "declencheurs": "Correspondance profonde",
        "posture_adaptative": "S'accorder sans se perdre; Vibrer ensemble tout en restant soi",
        "etats_compatibles": "1, 7, 12, 44, 60",
        "etats_sequenciels": "12, 28, 44, 61",
        "conseil_flowme": "Résonner c'est reconnaître ce qui en vous répond à ce qui vous touche"
    },
    "Doute": {
        "id": 9,
        "famille_symbolique": "Questionnement fertile",
        "tension_dominante": "Interrogative, prudente",
        "mot_cle": "Incertitude",
        "declencheurs": "Remise en question nécessaire",
        "posture_adaptative": "Accueillir l'incertitude; Ne pas précipiter les certitudes",
        "etats_compatibles": "3, 10, 17, 25, 48",
        "etats_sequenciels": "10, 11, 17, 25",
        "conseil_flowme": "Le doute intelligent protège de l'erreur et ouvre à la découverte"
    },
    "Prudence": {
        "id": 10,
        "famille_symbolique": "Sage retenue",
        "tension_dominante": "Mesurée, protectrice",
        "mot_cle": "Circonspection",
        "declencheurs": "Risque perçu, complexité",
        "posture_adaptative": "Avancer pas à pas; Évaluer sans paralyser",
        "etats_compatibles": "9, 11, 19, 26, 31",
        "etats_sequenciels": "11, 19, 26, 27",
        "conseil_flowme": "La prudence éclairée distingue la méfiance stérile de la précaution fertile"
    },
    "Retenue": {
        "id": 11,
        "famille_symbolique": "Force contenue",
        "tension_dominante": "Contrôlée, concentrée",
        "mot_cle": "Maîtrise",
        "declencheurs": "Besoin de ne pas agir immédiatement",
        "posture_adaptative": "Contenir sans réprimer; Garder la force disponible",
        "etats_compatibles": "1, 10, 12, 45, 52",
        "etats_sequenciels": "12, 19, 45, 52",
        "conseil_flowme": "La retenue sage préserve l'énergie pour le moment juste"
    },
    "Écoute": {
        "id": 12,
        "famille_symbolique": "Réceptivité pure",
        "tension_dominante": "Accueillante, disponible",
        "mot_cle": "Réception",
        "declencheurs": "Besoin de comprendre l'autre",
        "posture_adaptative": "Écouter sans préparer sa réponse; Accueillir sans juger",
        "etats_compatibles": "8, 11, 20, 28, 45",
        "etats_sequenciels": "20, 28, 45, 56",
        "conseil_flowme": "Écouter vraiment transforme autant celui qui écoute que celui qui parle"
    },
    "Créativité": {
        "id": 13,
        "famille_symbolique": "Élan créateur",
        "tension_dominante": "Générative, innovante",
        "mot_cle": "Innovation",
        "declencheurs": "Inspiration, besoin de nouveauté",
        "posture_adaptative": "Laisser créer à travers soi; Ne pas diriger le processus",
        "etats_compatibles": "3, 16, 29, 39, 53",
        "etats_sequenciels": "16, 29, 39, 53",
        "conseil_flowme": "La créativité authentique surprend d'abord celui qui crée"
    },
    "Clarté": {
        "id": 14,
        "famille_symbolique": "Évidence lumineuse",
        "tension_dominante": "Transparente, révélatrice",
        "mot_cle": "Évidence",
        "declencheurs": "Confusion qui se dissipe",
        "posture_adaptative": "Accueillir la clarté sans la forcer; La laisser se déployer",
        "etats_compatibles": "4, 6, 7, 15, 58",
        "etats_sequenciels": "15, 22, 30, 58",
        "conseil_flowme": "La vraie clarté n'éblouit pas, elle révèle"
    },
    "Discernement": {
        "id": 15,
        "famille_symbolique": "Vision ajustée",
        "tension_dominante": "Discriminante, précise",
        "mot_cle": "Distinction",
        "declencheurs": "Besoin de différencier",
        "posture_adaptative": "Distinguer sans séparer; Voir les nuances",
        "etats_compatibles": "5, 14, 23, 31, 58",
        "etats_sequenciels": "22, 23, 30, 31",
        "conseil_flowme": "Discerner c'est voir la juste mesure de chaque chose"
    },
    "Émerveillement": {
        "id": 16,
        "famille_symbolique": "Enchantement authentique",
        "tension_dominante": "Admirative, reconnaissante",
        "mot_cle": "Admiration",
        "declencheurs": "Beauté, grandeur perçue",
        "posture_adaptative": "S'abandonner à l'émerveillement; Ne pas analyser immédiatement",
        "etats_compatibles": "2, 4, 13, 24, 62",
        "etats_sequenciels": "24, 29, 62, 64",
        "conseil_flowme": "L'émerveillement nourrit l'âme et renouvelle la perception"
    },
    "Questionnement": {
        "id": 17,
        "famille_symbolique": "Recherche vivante",
        "tension_dominante": "Interrogative, exploratrice",
        "mot_cle": "Question",
        "declencheurs": "Mystère à explorer",
        "posture_adaptative": "Questionner sans attendre de réponse immédiate; Habiter la question",
        "etats_compatibles": "3, 9, 25, 34, 48",
        "etats_sequenciels": "3, 9, 25, 34",
        "conseil_flowme": "Une vraie question transforme plus que mille réponses toutes faites"
    },
    "Équilibre": {
        "id": 18,
        "famille_symbolique": "Harmonie dynamique",
        "tension_dominante": "Stabilisante, ajustée",
        "mot_cle": "Harmonie",
        "declencheurs": "Déséquilibre à corriger",
        "posture_adaptative": "Chercher l'équilibre dans le mouvement; Ajuster en permanence",
        "etats_compatibles": "19, 21, 22, 35, 60",
        "etats_sequenciels": "21, 22, 35, 60",
        "conseil_flowme": "L'équilibre véritable est un mouvement, pas une position"
    },
    "Patience": {
        "id": 19,
        "famille_symbolique": "Durée consentie",
        "tension_dominante": "Persévérante, constante",
        "mot_cle": "Persévérance",
        "declencheurs": "Processus qui demande du temps",
        "posture_adaptative": "Accepter le rythme naturel; Ne pas forcer la maturation",
        "etats_compatibles": "10, 18, 27, 32, 52",
        "etats_sequenciels": "27, 32, 52, 61",
        "conseil_flowme": "La patience n'est pas de l'attente passive, c'est une présence active au temps nécessaire"
    },
    "Réceptivité": {
        "id": 20,
        "famille_symbolique": "Ouverture accueillante",
        "tension_dominante": "Disponible, perméable",
        "mot_cle": "Disponibilité",
        "declencheurs": "Nouveau qui veut entrer",
        "posture_adaptative": "S'ouvrir sans se perdre; Accueillir en restant centré",
        "etats_compatibles": "12, 28, 36, 45, 56",
        "etats_sequenciels": "12, 28, 45, 56",
        "conseil_flowme": "Être réceptif c'est créer un espace où le nouveau peut advenir"
    },
    "Adaptation": {
        "id": 21,
        "famille_symbolique": "Souplesse intelligente",
        "tension_dominante": "Flexible, responsive",
        "mot_cle": "Ajustement",
        "declencheurs": "Changement de contexte",
        "posture_adaptative": "S'adapter sans se renier; Rester souple sans perdre son centre",
        "etats_compatibles": "18, 35, 36, 57, 63",
        "etats_sequenciels": "35, 36, 57, 63",
        "conseil_flowme": "S'adapter c'est danser avec le changement sans perdre sa mélodie intérieure"
    },
    "Cohérence": {
        "id": 22,
        "famille_symbolique": "Unité vivante",
        "tension_dominante": "Unifiante, intégrative",
        "mot_cle": "Intégrité",
        "declencheurs": "Éparpillement à unifier",
        "posture_adaptative": "Rechercher l'unité sans rigidité; Intégrer les contradictions",
        "etats_compatibles": "6, 14, 18, 30, 59",
        "etats_sequenciels": "30, 59, 61, 64",
        "conseil_flowme": "La cohérence authentique intègre même les contradictions apparentes"
    },
    "Précision": {
        "id": 23,
        "famille_symbolique": "Justesse affinée",
        "tension_dominante": "Exacte, ajustée",
        "mot_cle": "Exactitude",
        "declencheurs": "Besoin de justesse",
        "posture_adaptative": "Affiner sans rigidifier; Chercher la justesse, pas la perfection",
        "etats_compatibles": "5, 15, 31, 36, 55",
        "etats_sequenciels": "31, 36, 55, 56",
        "conseil_flowme": "La précision véritable unit la rigueur et la souplesse"
    },
    "Stupéfaction": {
        "id": 24,
        "famille_symbolique": "Saisissement révélateur",
        "tension_dominante": "Bouleversée, ouverte",
        "mot_cle": "Bouleversement",
        "declencheurs": "Révélation soudaine majeure",
        "posture_adaptative": "Accueillir le bouleversement; Laisser se réorganiser",
        "etats_compatibles": "4, 16, 33, 41, 46",
        "etats_sequenciels": "33, 41, 46, 58",
        "conseil_flowme": "La stupéfaction ouvre des espaces neufs en nous"
    },
    "Perplexité": {
        "id": 25,
        "famille_symbolique": "Questionnement dérouté",
        "tension_dominante": "Déconcertée, cherchante",
        "mot_cle": "Désorientation",
        "declencheurs": "Situation incompréhensible",
        "posture_adaptative": "Accepter de ne pas comprendre; Rester ouvert à l'émergence",
        "etats_compatibles": "9, 17, 33, 47, 48",
        "etats_sequenciels": "33, 47, 48, 49",
        "conseil_flowme": "La perplexité fertile préfère l'inconnu authentique aux certitudes factices"
    },
    "Vigilance": {
        "id": 26,
        "famille_symbolique": "Attention soutenue",
        "tension_dominante": "Alerte, attentive",
        "mot_cle": "Vigilance",
        "declencheurs": "Situation demandant attention",
        "posture_adaptative": "Rester alerte sans tension; Surveiller sans crispation",
        "etats_compatibles": "3, 10, 27, 37, 50",
        "etats_sequenciels": "27, 37, 50, 51",
        "conseil_flowme": "La vraie vigilance est détendue et précise à la fois"
    },
    "Persévérance": {
        "id": 27,
        "famille_symbolique": "Constance déterminée",
        "tension_dominante": "Tenace, endurante",
        "mot_cle": "Ténacité",
        "declencheurs": "Résistance à surmonter",
        "posture_adaptative": "Persévérer sans s'endurcir; Maintenir l'élan sans forcer",
        "etats_compatibles": "10, 19, 26, 31, 38",
        "etats_sequenciels": "31, 37, 38, 50",
        "conseil_flowme": "Persévérer c'est maintenir la direction tout en restant souple sur les moyens"
    },
    "Compassion": {
        "id": 28,
        "famille_symbolique": "Bienveillance active",
        "tension_dominante": "Aimante, compatissante",
        "mot_cle": "Bienveillance",
        "declencheurs": "Souffrance perçue",
        "posture_adaptative": "Compatir sans s'identifier; Aider sans s'épuiser",
        "etats_compatibles": "8, 12, 20, 56, 61",
        "etats_sequenciels": "56, 61, 62, 64",
        "conseil_flowme": "La compassion authentique guérit autant celui qui la donne que celui qui la reçoit"
    },
    "Inspiration": {
        "id": 29,
        "famille_symbolique": "Souffle créateur",
        "tension_dominante": "Inspirée, porteuse",
        "mot_cle": "Inspiration",
        "declencheurs": "Élan créateur qui monte",
        "posture_adaptative": "Laisser l'inspiration agir; Ne pas la diriger",
        "etats_compatibles": "2, 6, 7, 13, 16",
        "etats_sequenciels": "13, 39, 53, 62",
        "conseil_flowme": "L'inspiration vraie traverse celui qui la reçoit pour toucher le monde"
    },
    "Sagesse": {
        "id": 30,
        "famille_symbolique": "Compréhension mûrie",
        "tension_dominante": "Sage, intégrée",
        "mot_cle": "Sagesse",
        "declencheurs": "Intégration d'expériences multiples",
        "posture_adaptative": "Partager sans imposer; Éclairer sans éblouir",
        "etats_compatibles": "6, 14, 15, 22, 61",
        "etats_sequenciels": "61, 62, 63, 64",
        "conseil_flowme": "La sagesse se reconnaît à sa simplicité et à sa justesse"
    },
    "Rigueur": {
        "id": 31,
        "famille_symbolique": "Exigence féconde",
        "tension_dominante": "Exigeante, structurante",
        "mot_cle": "Exigence",
        "declencheurs": "Besoin de structure et précision",
        "posture_adaptative": "Être rigoureux sans être rigide; Structurer sans enfermer",
        "etats_compatibles": "5, 10, 15, 23, 27",
        "etats_sequenciels": "23, 36, 38, 55",
        "conseil_flowme": "La rigueur authentique libère en donnant une forme juste"
    },
    "Contemplation": {
        "id": 32,
        "famille_symbolique": "Regard profond",
        "tension_dominante": "Contemplative, absorbée",
        "mot_cle": "Contemplation",
        "declencheurs": "Beauté ou mystère à contempler",
        "posture_adaptative": "Se laisser absorber sans se perdre; Contempler sans posséder",
        "etats_compatibles": "1, 19, 45, 52, 61",
        "etats_sequenciels": "45, 52, 61, 64",
        "conseil_flowme": "Contempler c'est laisser être ce qui est dans toute sa richesse"
    },
    # États 33-64 avec des noms plus complexes et nuancés
    "Altération des repères": {
        "id": 33,
        "famille_symbolique": "Déstabilisation nécessaire",
        "tension_dominante": "Désorientée, flottante",
        "mot_cle": "Déstabilisation",
        "declencheurs": "Perte de références habituelles",
        "posture_adaptative": "Accepter la désorientation; Ne pas se raccrocher aux anciens repères",
        "etats_compatibles": "24, 25, 34, 47, 49",
        "etats_sequenciels": "34, 47, 49, 52",
        "conseil_flowme": "Perdre ses repères peut être le prélude à en découvrir de plus vastes"
    },
    "Perception élargie": {
        "id": 34,
        "famille_symbolique": "Vision expansée",
        "tension_dominante": "Élargie, panoramique",
        "mot_cle": "Expansion",
        "declencheurs": "Ouverture perceptuelle soudaine",
        "posture_adaptative": "Accueillir l'élargissement; Ne pas se perdre dans l'immensité",
        "etats_compatibles": "3, 17, 33, 39, 41",
        "etats_sequenciels": "39, 41, 42, 58",
        "conseil_flowme": "Une perception élargie demande un centre stable pour ne pas se disperser"
    },
    "Ajustement souple": {
        "id": 35,
        "famille_symbolique": "Adaptation fluide",
        "tension_dominante": "Souple, adaptative",
        "mot_cle": "Fluidité",
        "declencheurs": "Nécessité d'adaptation fine",
        "posture_adaptative": "S'ajuster en permanence; Rester fluide sans perdre la direction",
        "etats_compatibles": "18, 21, 36, 57, 63",
        "etats_sequenciels": "36, 57, 63, 64",
        "conseil_flowme": "L'ajustement souple unit la fermeté de l'intention et la souplesse des moyens"
    },
    "Présence ajustée": {
        "id": 36,
        "famille_symbolique": "Présence calibrée",
        "tension_dominante": "Ajustée, précise",
        "mot_cle": "Calibrage",
        "declencheurs": "Besoin de présence juste",
        "posture_adaptative": "Calibrer sa présence; Ni trop ni trop peu",
        "etats_compatibles": "20, 23, 31, 35, 55",
        "etats_sequenciels": "55, 56, 59, 63",
        "conseil_flowme": "La présence ajustée donne exactement ce qui est nécessaire"
    },
    "Volonté excessive": {
        "id": 37,
        "famille_symbolique": "Force mal dirigée",
        "tension_dominante": "Tendue, forcée",
        "mot_cle": "Excès",
        "declencheurs": "Résistance qui durcit la volonté",
        "posture_adaptative": "Reconnaître l'excès; Relâcher progressivement la tension",
        "etats_compatibles": "26, 27, 38, 50, 51",
        "etats_sequenciels": "38, 50, 51, 52",
        "conseil_flowme": "Quand la volonté devient excessive, c'est qu'elle a perdu sa justesse"
    },
    "Rigidité fonctionnelle": {
        "id": 38,
        "famille_symbolique": "Structure durcie",
        "tension_dominante": "Rigide, crispée",
        "mot_cle": "Rigidité",
        "declencheurs": "Peur du changement",
        "posture_adaptative": "Reconnaître la rigidité; Introduire de la souplesse graduellement",
        "etats_compatibles": "27, 31, 37, 50, 51",
        "etats_sequenciels": "50, 51, 52, 53",
        "conseil_flowme": "La rigidité protège momentanément mais limite l'évolution"
    },
    "Vol d'altitude": {
        "id": 39,
        "famille_symbolique": "Élévation panoramique",
        "tension_
