"Vol d'altitude": {
        "id": 39,
        "famille_symbolique": "√âl√©vation panoramique",
        "tension_dominante": "√âlev√©e, surplombante",
        "mot_cle": "√âl√©vation",
        "declencheurs": "Besoin de perspective globale",
        "posture_adaptative": "Prendre de la hauteur sans perdre le contact; Observer sans juger",
        "etats_compatibles": "13, 29, 34, 40, 42",
        "etats_sequenciels": "40, 42, 43, 58",
        "conseil_flowme": "Prendre de l'altitude permet de voir les connexions invisibles depuis le sol"
    },
    "Retour porteur": {
        "id": 40,
        "famille_symbolique": "Redescente enrichie",
        "tension_dominante": "Descendante, porteuse",
        "mot_cle": "Retour",
        "declencheurs": "Retour apr√®s √©l√©vation",
        "posture_adaptative": "Redescendre en gardant l'acquis; Int√©grer l'exp√©rience d'altitude",
        "etats_compatibles": "39, 42, 43, 56, 63",
        "etats_sequenciels": "43, 56, 63, 64",
        "conseil_flowme": "Le retour authentique ram√®ne les tr√©sors de l'altitude dans la vie ordinaire"
    },
    "√âveil d'empreinte": {
        "id": 41,
        "famille_symbolique": "R√©veil de m√©moire",
        "tension_dominante": "√âveillante, r√©v√©latrice",
        "mot_cle": "√âveil",
        "declencheurs": "R√©sonance avec une empreinte ancienne",
        "posture_adaptative": "Accueillir ce qui s'√©veille; Ne pas forcer la m√©moire",
        "etats_compatibles": "2, 24, 34, 48, 49",
        "etats_sequenciels": "42, 48, 49, 58",
        "conseil_flowme": "Certains √©veils r√©v√®lent ce qui √©tait d√©j√† l√†, endormi"
    },
    "Pr√©cipitation du sens": {
        "id": 42,
        "famille_symbolique": "Cristallisation rapide",
        "tension_dominante": "Pr√©cipitante, condensante",
        "mot_cle": "Cristallisation",
        "declencheurs": "Compr√©hension soudaine",
        "posture_adaptative": "Laisser se cristalliser; Ne pas forcer la formulation",
        "etats_compatibles": "34, 39, 40, 43, 58",
        "etats_sequenciels": "43, 44, 58, 59",
        "conseil_flowme": "Quand le sens pr√©cipite, c'est que la solution √©tait d√©j√† pr√©sente"
    },
    "Retomb√©e harmonique": {
        "id": 43,
        "famille_symbolique": "R√©sonance apais√©e",
        "tension_dominante": "Apaisante, harmonisante",
        "mot_cle": "Harmonie",
        "declencheurs": "R√©solution d'une tension",
        "posture_adaptative": "Accueillir l'apaisement; Laisser l'harmonie s'installer",
        "etats_compatibles": "40, 42, 44, 60, 61",
        "etats_sequenciels": "44, 60, 61, 64",
        "conseil_flowme": "Apr√®s l'intensit√©, la retomb√©e harmonique permet l'int√©gration"
    },
    "Geste r√©sonant": {
        "id": 44,
        "famille_symbolique": "Action accord√©e",
        "tension_dominante": "Accord√©e, juste",
        "mot_cle": "Justesse",
        "declencheurs": "Moment d'action juste",
        "posture_adaptative": "Agir dans la justesse; Laisser le geste na√Ætre de l'accord",
        "etats_compatibles": "8, 42, 43, 55, 56",
        "etats_sequenciels": "55, 56, 59, 63",
        "conseil_flowme": "Le geste r√©sonant unit parfaitement l'intention et l'action"
    },
    "Disponibilit√© nue": {
        "id": 45,
        "famille_symbolique": "Ouverture totale",
        "tension_dominante": "Nue, disponible",
        "mot_cle": "Disponibilit√©",
        "declencheurs": "L√¢cher-prise total",
        "posture_adaptative": "√ätre disponible sans attente; S'ouvrir sans se perdre",
        "etats_compatibles": "1, 11, 12, 20, 32",
        "etats_sequenciels": "52, 56, 61, 64",
        "conseil_flowme": "La disponibilit√© nue est l'√©tat le plus r√©ceptif et le plus cr√©ateur"
    },
    "Choc d'ombre": {
        "id": 46,
        "famille_symbolique": "R√©v√©lation brutale",
        "tension_dominante": "Choquante, r√©v√©latrice",
        "mot_cle": "R√©v√©lation",
        "declencheurs": "D√©couverte de ce qui √©tait cach√©",
        "posture_adaptative": "Accueillir le choc; Ne pas fuir ce qui se r√©v√®le",
        "etats_compatibles": "24, 47, 49, 51, 53",
        "etats_sequenciels": "47, 49, 51, 53",
        "conseil_flowme": "Le choc d'ombre r√©v√®le ce que la lumi√®re seule ne peut montrer"
    },
    "D√©rive int√©rieure": {
        "id": 47,
        "famille_symbolique": "Errance interne",
        "tension_dominante": "D√©rivante, flottante",
        "mot_cle": "D√©rive",
        "declencheurs": "Perte de direction interne",
        "posture_adaptative": "Accepter la d√©rive; Faire confiance au courant profond",
        "etats_compatibles": "25, 33, 46, 48, 49",
        "etats_sequenciels": "48, 49, 52, 53",
        "conseil_flowme": "Parfois il faut d√©river pour d√©couvrir des rivages inconnus"
    },
    "Remont√©e de m√©moire ancienne": {
        "id": 48,
        "famille_symbolique": "R√©surgence du pass√©",
        "tension_dominante": "Remontante, r√©v√©latrice",
        "mot_cle": "M√©moire",
        "declencheurs": "R√©activation d'une m√©moire profonde",
        "posture_adaptative": "Accueillir ce qui remonte; Ne pas rejuger le pass√©",
        "etats_compatibles": "9, 17, 25, 41, 47",
        "etats_sequenciels": "41, 49, 52, 58",
        "conseil_flowme": "Ce qui remonte du pass√© vient √©clairer le pr√©sent"
    },
    "R√©surgence incontr√¥l√©e": {
        "id": 49,
        "famille_symbolique": "√âmergence chaotique",
        "tension_dominante": "Incontr√¥l√©e, d√©bordante",
        "mot_cle": "Chaos",
        "declencheurs": "D√©bordement √©motionnel ou mental",
        "posture_adaptative": "Ne pas lutter contre le chaos; Attendre que √ßa se pose",
        "etats_compatibles": "25, 33, 41, 46, 47",
        "etats_sequenciels": "50, 51, 52, 53",
        "conseil_flowme": "M√™me le chaos porte en lui les germes d'un nouvel ordre"
    },
    "Saturation et perte d'adh√©rence": {
        "id": 50,
        "famille_symbolique": "Surcharge critique",
        "tension_dominante": "Satur√©e, glissante",
        "mot_cle": "Saturation",
        "declencheurs": "D√©passement des capacit√©s",
        "posture_adaptative": "Reconna√Ætre la saturation; All√©ger progressivement",
        "etats_compatibles": "26, 37, 38, 49, 51",
        "etats_sequenciels": "51, 52, 53, 54",
        "conseil_flowme": "La saturation signale qu'il est temps de simplifier et d'all√©ger"
    },
    "Fracture identitaire": {
        "id": 51,
        "famille_symbolique": "Rupture int√©rieure",
        "tension_dominante": "Fractur√©e, divis√©e",
        "mot_cle": "Fracture",
        "declencheurs": "Contradiction interne majeure",
        "posture_adaptative": "Accepter la fracture; Ne pas forcer l'unit√© pr√©matur√©ment",
        "etats_compatibles": "37, 38, 46, 49, 50",
        "etats_sequenciels": "52, 53, 54, 55",
        "conseil_flowme": "Parfois il faut se briser pour se reconstruire plus authentiquement"
    },
    "Silence matriciel": {
        "id": 52,
        "famille_symbolique": "Silence cr√©ateur",
        "tension_dominante": "Silencieuse, matricielle",
        "mot_cle": "Silence",
        "declencheurs": "Besoin de silence profond",
        "posture_adaptative": "Habiter le silence; Laisser na√Ætre de la vacuit√©",
        "etats_compatibles": "11, 19, 32, 45, 47",
        "etats_sequenciels": "53, 54, 55, 61",
        "conseil_flowme": "Le silence matriciel est le ventre o√π naissent les nouvelles formes"
    },
    "Tension du renouveau": {
        "id": 53,
        "famille_symbolique": "Pouss√©e cr√©atrice",
        "tension_dominante": "Tendue, cr√©atrice",
        "mot_cle": "Renouveau",
        "declencheurs": "√âlan de renouvellement",
        "posture_adaptative": "Accompagner la pouss√©e; Ne pas pr√©cipiter la naissance",
        "etats_compatibles": "13, 29, 46, 49, 52",
        "etats_sequenciels": "54, 55, 56, 62",
        "conseil_flowme": "Le renouveau authentique na√Æt de la destruction cr√©atrice de l'ancien"
    },
    "Premi√®re inclinaison": {
        "id": 54,
        "famille_symbolique": "Mouvement naissant",
        "tension_dominante": "Naissante, orient√©e",
        "mot_cle": "Orientation",
        "declencheurs": "Premi√®re direction qui se dessine",
        "posture_adaptative": "Suivre l'inclinaison; Ne pas forcer la direction",
        "etats_compatibles": "50, 51, 52, 53, 55",
        "etats_sequenciels": "55, 56, 57, 63",
        "conseil_flowme": "La premi√®re inclinaison indique la direction naturelle du renouveau"
    },
    "Geste t√©nu": {
        "id": 55,
        "famille_symbolique": "Action d√©licate",
        "tension_dominante": "T√©nue, pr√©cise",
        "mot_cle": "D√©licatesse",
        "declencheurs": "Situation demandant finesse",
        "posture_adaptative": "Agir avec d√©licatesse; Doser finement l'intervention",
        "etats_compatibles": "23, 36, 44, 52, 54",
        "etats_sequenciels": "56, 57, 59, 63",
        "conseil_flowme": "Les gestes les plus t√©nus peuvent avoir les effets les plus profonds"
    },
    "Reprise accord√©e": {
        "id": 56,
        "famille_symbolique": "Recommencement harmonieux",
        "tension_dominante": "Accord√©e, renouvel√©e",
        "mot_cle": "Reprise",
        "declencheurs": "Nouveau d√©part possible",
        "posture_adaptative": "Reprendre en gardant l'acquis; Recommencer autrement",
        "etats_compatibles": "20, 28, 40, 44, 55",
        "etats_sequenciels": "57, 59, 63, 64",
        "conseil_flowme": "La reprise accord√©e unit l'exp√©rience pass√©e et l'√©lan nouveau"
    },
    "Dualit√© vivante": {
        "id": 57,
        "famille_symbolique": "Opposition cr√©atrice",
        "tension_dominante": "Duelle, cr√©atrice",
        "mot_cle": "Polarit√©",
        "declencheurs": "Tensions oppos√©es √† int√©grer",
        "posture_adaptative": "Tenir les deux p√¥les; Ne pas choisir pr√©matur√©ment",
        "etats_compatibles": "21, 35, 54, 55, 58",
        "etats_sequenciels": "58, 59, 60, 63",
        "conseil_flowme": "La dualit√© vivante g√©n√®re une dynamique cr√©atrice"
    },
    "Clart√© paradoxale": {
        "id": 58,
        "famille_symbolique": "√âvidence contradictoire",
        "tension_dominante": "Claire, paradoxale",
        "mot_cle": "Paradoxe",
        "declencheurs": "V√©rit√© paradoxale qui se r√©v√®le",
        "posture_adaptative": "Accepter le paradoxe; Ne pas forcer la logique",
        "etats_compatibles": "4, 14, 34, 42, 57",
        "etats_sequenciels": "59, 60, 61, 64",
        "conseil_flowme": "La clart√© paradoxale r√©v√®le que la v√©rit√© d√©passe souvent la logique"
    },
    "Inclusion active": {
        "id": 59,
        "famille_symbolique": "Int√©gration dynamique",
        "tension_dominante": "Inclusive, active",
        "mot_cle": "Inclusion",
        "declencheurs": "Besoin d'int√©grer tous les √©l√©ments",
        "posture_adaptative": "Inclure sans diluer; Int√©grer en gardant les sp√©cificit√©s",
        "etats_compatibles": "1, 6, 22, 36, 56",
        "etats_sequenciels": "60, 61, 63, 64",
        "conseil_flowme": "L'inclusion active cr√©e une unit√© qui respecte la diversit√©"
    },
    "Rythme paradoxal": {
        "id": 60,
        "famille_symbolique": "Tempo complexe",
        "tension_dominante": "Rythm√©e, paradoxale",
        "mot_cle": "Rythme",
        "declencheurs": "Synchronisation complexe n√©cessaire",
        "posture_adaptative": "Suivre le rythme paradoxal; Accepter les tempos contradictoires",
        "etats_compatibles": "8, 18, 43, 57, 58",
        "etats_sequenciels": "61, 62, 63, 64",
        "conseil_flowme": "Le rythme paradoxal unit les contraires dans une danse unique"
    },
    "Pl√©nitude tranquille": {
        "id": 61,
        "famille_symbolique": "Accomplissement serein",
        "tension_dominante": "Pleine, tranquille",
        "mot_cle": "Pl√©nitude",
        "declencheurs": "Sentiment d'accomplissement",
        "posture_adaptative": "Habiter la pl√©nitude; Go√ªter sans s'attacher",
        "etats_compatibles": "19, 28, 30, 32, 43",
        "etats_sequenciels": "62, 63, 64, 1",
        "conseil_flowme": "La pl√©nitude tranquille est un repos dans l'√™tre"
    },
    "Rayonnement discret": {
        "id": 62,
        "famille_symbolique": "Influence subtile",
        "tension_dominante": "Rayonnante, discr√®te",
        "mot_cle": "Rayonnement",
        "declencheurs": "Qualit√© qui veut se partager",
        "posture_adaptative": "Rayonner sans ostentation; Influencer par l'√™tre",
        "etats_compatibles": "7, 16, 28, 29, 30",
        "etats_sequenciels": "63, 64, 1, 2",
        "conseil_flowme": "Le rayonnement discret touche sans forcer"
    },
    "Passage vivant": {
        "id": 63,
        "famille_symbolique": "Transition cr√©atrice",
        "tension_dominante": "Transitoire, cr√©atrice",
        "mot_cle": "Passage",
        "declencheurs": "Moment de transition",
        "posture_adaptative": "Habiter le passage; Ne pas pr√©cipiter l'arriv√©e",
        "etats_compatibles": "21, 35, 40, 56, 60",
        "etats_sequenciels": "64, 1, 2, 3",
        "conseil_flowme": "Le passage vivant transforme en reliant"
    },
    "Porte ouverte": {
        "id": 64,
        "famille_symbolique": "Ouverture totale",
        "tension_dominante": "Ouverte, accueillante",
        "mot_cle": "Ouverture",
        "declencheurs": "Disponibilit√© compl√®te",
        "posture_adaptative": "√ätre une porte ouverte; Accueillir tout ce qui vient",
        "etats_compatibles": "1, 16, 22, 28, 30",
        "etats_sequenciels": "1, 2, 3, 16",
        "conseil_flowme": "√ätre porte ouverte, c'est offrir un passage entre les mondes"
    }
}

# ========== SYST√àME DE MONITORING ==========
@dataclass
class ConversationMetrics:
    session_id: str
    user_id: str
    start_time: datetime
    end_time: Optional[datetime]
    message_count: int
    emotions_detected: list
    average_response_time: float

@dataclass
class SystemHealthMetrics:
    timestamp: datetime
    nocodb_status: bool
    mistral_status: bool
    response_times: Dict[str, float]
    error_count: int
    active_sessions: int

class FlowMeAnalytics:
    def __init__(self):
        self.conversations: Dict[str, ConversationMetrics] = {}
        self.health_history = []
        self.emotion_stats = Counter()
        self.error_log = []
        self.system_start_time = datetime.now()
        
    def start_conversation(self, session_id: str, user_id: str = "anonymous"):
        self.conversations[session_id] = ConversationMetrics(
            session_id=session_id,
            user_id=user_id,
            start_time=datetime.now(),
            end_time=None,
            message_count=0,
            emotions_detected=[],
            average_response_time=0.0
        )
        
    def log_message(self, session_id: str, emotion: str, response_time: float):
        if session_id in self.conversations:
            conv = self.conversations[session_id]
            conv.message_count += 1
            conv.emotions_detected.append(emotion)
            
            current_avg = conv.average_response_time
            conv.average_response_time = (current_avg * (conv.message_count - 1) + response_time) / conv.message_count
            
            self.emotion_stats[emotion] += 1
    
    def log_system_health(self, nocodb_status: bool, mistral_status: bool, 
                         response_times: Dict[str, float], error_count: int):
        health = SystemHealthMetrics(
            timestamp=datetime.now(),
            nocodb_status=nocodb_status,
            mistral_status=mistral_status,
            response_times=response_times,
            error_count=error_count,
            active_sessions=len([c for c in self.conversations.values() if c.end_time is None])
        )
        
        self.health_history.append(health)
        
        # Garder seulement les 24 derni√®res heures
        cutoff = datetime.now() - timedelta(hours=24)
        self.health_history = [h for h in self.health_history if h.timestamp > cutoff]
    
    def log_error(self, error_type: str, error_message: str, session_id: str = None):
        self.error_log.append({
            'timestamp': datetime.now(),
            'type': error_type,
            'message': error_message,
            'session_id': session_id
        })
        
        if len(self.error_log) > 100:
            self.error_log = self.error_log[-100:]
    
    def get_analytics_summary(self) -> Dict[str, Any]:
        now = datetime.now()
        uptime = (now - self.system_start_time).total_seconds()
        
        # Calculer l'uptime syst√®me
        system_uptime = 100.0
        if self.health_history:
            total_checks = len(self.health_history)
            successful = sum(1 for h in self.health_history if h.nocodb_status and h.mistral_status)
            system_uptime = (successful / total_checks) * 100 if total_checks > 0 else 100.0
        
        # Temps de r√©ponse moyen
        avg_response_time = 0.0
        if self.conversations:
            response_times = [c.average_response_time for c in self.conversations.values() if c.average_response_time > 0]
            avg_response_time = sum(response_times) / len(response_times) if response_times else 0.0
        
        return {
            "uptime_seconds": uptime,
            "total_conversations": len(self.conversations),
            "active_conversations": len([c for c in self.conversations.values() if c.end_time is None]),
            "total_messages": sum(c.message_count for c in self.conversations.values()),
            "system_uptime_percent": round(system_uptime, 2),
            "average_response_time": round(avg_response_time, 2),
            "top_emotions": dict(self.emotion_stats.most_common(5)),
            "recent_errors": len([e for e in self.error_log if e['timestamp'] > now - timedelta(hours=1)])
        }

# ========== APPLICATION PRINCIPALE ==========

app = FastAPI(title="FlowMe v3 - 64 √âtats", version="3.1.0")

# Variables d'environnement
MISTRAL_API_KEY = os.getenv("MISTRAL_API_KEY")
NOCODB_URL = os.getenv("NOCODB_URL", "https://app.nocodb.com")
NOCODB_API_KEY = os.getenv("NOCODB_API_KEY")
NOCODB_STATES_TABLE_ID = os.getenv("NOCODB_STATES_TABLE_ID", "mpcze1flcb4x64x")
NOCODB_REACTIONS_TABLE_ID = os.getenv("NOCODB_REACTIONS_TABLE_ID", "m8lwhj640ohzg7m")

class ChatMessage(BaseModel):
    message: str
    user_id: Optional[str] = "anonymous"

class Enhanced64StatesDetection:
    def __init__(self, source: str = "integrated"):
        self.states = FLOWME_64_STATES
        self.source = source
        # Stockage des donn√©es NocoDB additionnelles
        self.nocodb_additional_data = {}
        logger.info(f"‚úÖ FlowMe initialis√© avec 64 √©tats int√©gr√©s - Source: {source}")
    
    def add_nocodb_data(self, nocodb_data: Dict[str, Any]):
        """Ajoute les donn√©es NocoDB aux 64 √©tats de base"""
        self.nocodb_additional_data = nocodb_data
        logger.info(f"üìä Donn√©es NocoDB additionnelles ajout√©es: {len(nocodb_data)} √©tats")
    
    def detect_emotion(self, text: str) -> str:
        """D√©tection d'√©motion sophistiqu√©e sur les 64 √©tats"""
        text_lower = text.lower()
        
        # Scoring pour tous les 64 √©tats bas√© sur leurs caract√©ristiques
        emotion_scores = {}
        
        for state_name, state_data in self.states.items():
            score = 0
            
            # Analyse bas√©e sur le mot-cl√© principal
            if state_data["mot_cle"].lower() in text_lower:
                score += 5
            
            # Analyse des d√©clencheurs
            declencheurs = state_data["declencheurs"].lower()
            declencheur_words = declencheurs.split()
            for word in declencheur_words:
                if len(word) > 3 and word in text_lower:
                    score += 3
            
            # Analyse de la famille symbolique
            famille_words = state_data["famille_symbolique"].lower().split()
            for word in famille_words:
                if len(word) > 3 and word in text_lower:
                    score += 2
            
            # Analyse de la tension dominante
            tension_words = state_data["tension_dominante"].lower().split()
            for word in tension_words:
                if len(word) > 3 and word in text_lower:
                    score += 2
            
            # Mots-cl√©s sp√©ciaux par cat√©gories d'√©tats
            if "joie" in text_lower or "heur" in text_lower or "content" in text_lower:
                if "√©merveille" in state_name.lower() or "rayonne" in state_name.lower():
                    score += 4
            
            if "trist" in text_lower or "m√©lan" in text_lower or "sombre" in text_lower:
                if "silence" in state_name.lower() or "contempla" in state_name.lower():
                    score += 4
            
            if "peur" in text_lower or "anxie" in text_lower or "stress" in text_lower:
                if "vigilance" in state_name.lower() or "prudence" in state_name.lower():
                    score += 4
            
            if "col√®re" in text_lower or "√©nerv√©" in text_lower or "frustr√©" in text_lower:
                if "tension" in state_name.lower() or "excessive" in state_name.lower():
                    score += 4
            
            if "confusion" in text_lower or "perdu" in text_lower or "comprend pas" in text_lower:
                if "perplexit√©" in state_name.lower() or "alt√©ration" in state_name.lower():
                    score += 4
            
            if "√©merveil" in text_lower or "fascin" in text_lower or "d√©couvr" in text_lower:
                if "√©veil" in state_name.lower() or "√©merveillement" in state_name.lower():
                    score += 4
            
            if score > 0:
                emotion_scores[state_name] = score
        
        # Retourner l'√©tat avec le score le plus √©lev√©
        if emotion_scores:
            return max(emotion_scores, key=emotion_scores.get)
        
        return "Pr√©sence"  # D√©faut
    
    def get_state_for_mistral(self, detected_state: str) -> Dict[str, Any]:
        """R√©cup√®re les donn√©es compl√®tes d'un √©tat pour Mistral"""
        if detected_state in self.states:
            state_data = self.states[detected_state].copy()
            
            # Ajouter les donn√©es NocoDB si disponibles
            if detected_state in self.nocodb_additional_data:
                state_data.update(self.nocodb_additional_data[detected_state])
            
            return state_data
        
        return self.states.get("Pr√©sence", {})

# Instances globales
flowme_states = None
analytics = FlowMeAnalytics()

async def load_complete_states():
    global flowme_states
    
    logger.info("üîç Chargement du syst√®me FlowMe complet...")
    
    # Initialiser avec les 64 √©tats int√©gr√©s
    flowme_states = Enhanced64StatesDetection("64_√©tats_int√©gr√©s")
    
    nocodb_status = False
    
    # Essayer de charger des donn√©es additionnelles depuis NocoDB
    if NOCODB_API_KEY and NOCODB_STATES_TABLE_ID:
        try:
            headers = {"accept": "application/json", "xc-token": NOCODB_API_KEY}
            url = f"{NOCODB_URL}/api/v2/tables/{NOCODB_STATES_TABLE_ID}/records"
            
            async with httpx.AsyncClient(timeout=10.0) as client:
                response = await client.get(url, headers=headers)
                
                if response.status_code == 200:
                    data = response.json()
                    records = data.get("list", []) if isinstance(data, dict) else data
                    
                    if records:
                        nocodb_additional = {}
                        
                        for record in records:
                            if isinstance(record, dict):
                                name = record.get("Nom_√âtat")
                                if name and name in FLOWME_64_STATES:
                                    # Donn√©es additionnelles NocoDB
                                    nocodb_additional[name] = {
                                        "nocodb_id": record.get("ID_√âtat", ""),
                                        "nocodb_data": record
                                    }
                        
                        if nocodb_additional:
                            flowme_states.add_nocodb_data(nocodb_additional)
                            nocodb_status = True
                            logger.info(f"‚úÖ Donn√©es NocoDB additionnelles ajout√©es pour {len(nocodb_additional)} √©tats")
                        
        except Exception as e:
            logger.warning(f"‚ö†Ô∏è Erreur NocoDB (non critique): {e}")
            analytics.log_error("nocodb_additional", str(e))
    
    logger.info(f"üéØ Syst√®me FlowMe COMPLET initialis√©:")
    logger.info(f"   üìä 64 √©tats int√©gr√©s disponibles")
    logger.info(f"   üîó NocoDB: {'‚úÖ Connect√©' if nocodb_status else '‚ö†Ô∏è Non disponible'}")
    logger.info(f"   ü§ñ Mistral a acc√®s aux 64 √©tats complets")
    
    return nocodb_status

async def save_to_nocodb(user_message: str, ai_response: str, detected_state: str, user_id: str):
    if not NOCODB_API_KEY:
        return False
    
    try:
        headers = {
            "accept": "application/json",
            "Content-Type": "application/json",
            "xc-token": NOCODB_API_KEY
        }
        
        url = f"{NOCODB_URL}/api/v2/tables/{NOCODB_REACTIONS_TABLE_ID}/records"
        payload = {
            "etat_nom": detected_state,
            "tension_dominante": ai_response[:1000],
            "famille_symbolique": user_message[:500],
            "session_id": user_id,
            "timestamp": datetime.now().isoformat()
        }
        
        async with httpx.AsyncClient(timeout=8.0) as client:
            response = await client.post(url, headers=headers, json=payload)
            return response.status_code in [200, 201]
    except Exception as e:
        analytics.log_error("nocodb_save", str(e))
        return False

async def generate_mistral_response(message: str, detected_state: str) -> tuple[str, bool]:
    mistral_status = False
    
    if not MISTRAL_API_KEY:
        return f"Je comprends que vous ressentez '{detected_state}'. Comment puis-je vous accompagner ?", mistral_status
    
    try:
        # R√âCUP√âRER LES DONN√âES COMPL√àTES de l'√©tat (64 √©tats)
        state_data = flowme_states.get_state_for_mistral(detected_state)
        
        # Construire le prompt enrichi avec TOUTES les donn√©es des 64 √©tats
        system_prompt = f"""Tu es FlowMe, un compagnon IA empathique sp√©cialis√© dans l'accompagnement √©motionnel bas√© sur 64 √©tats de conscience sp√©cifiques.

√âTAT D√âTECT√â: {detected_state} (ID: {state_data.get('id', '')})

DONN√âES COMPL√àTES DE L'√âTAT:
- Famille symbolique: {state_data.get('famille_symbolique', '')}
- Tension dominante: {state_data.get('tension_dominante', '')}
- Mot-cl√©: {state_data.get('mot_cle', '')}
- D√©clencheurs: {state_data.get('declencheurs', '')}
- Posture adaptative: {state_data.get('posture_adaptative', '')}
- √âtats compatibles: {state_data.get('etats_compatibles', '')}
- √âtats s√©quenciels: {state_data.get('etats_sequenciels', '')}
- Conseil FlowMe: {state_data.get('conseil_flowme', '')}

INSTRUCTIONS POUR MISTRAL:
1. Utilise la "Famille symbolique" pour cr√©er une atmosph√®re po√©tique appropri√©e
2. Utilise la "Tension dominante" pour comprendre l'√©nergie sp√©cifique de l'√©tat
3. Int√®gre le "Conseil FlowMe" de mani√®re naturelle et sage
4. Propose la "Posture adaptative" comme guidance pratique concr√®te
5. Valide l'exp√©rience en r√©f√©rence aux "D√©clencheurs"
6. Si appropri√©, mentionne discr√®tement les "√âtats compatibles" ou "s√©quenciels"
7. Reste empathique, sage et bienveillant (max 150 mots)
8. Parle comme un guide exp√©riment√© qui conna√Æt intimement ces 64 √©tats

Message de l'utilisateur: {message}"""

        headers = {
            "Authorization": f"Bearer {MISTRAL_API_KEY}",
            "Content-Type": "application/json"
        }
        
        payload = {
            "model": "mistral-small-latest",
            "messages": [
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": message}
            ],
            "temperature": 0.7,
            "max_tokens": 200
        }
        
        async with httpx.AsyncClient(timeout=15.0) as client:
            response = await client.post(
                "https://api.mistral.ai/v1/chat/completions",
                headers=headers,
                json=payload
            )
            
            if response.status_code == 200:
                result = response.json()
                mistral_status = True
                return result["choices"][0]["message"]["content"].strip(), mistral_status
                
    except Exception as e:
        analytics.log_error("mistral_api", str(e))
        logger.error(f"Erreur Mistral API: {e}")
    
    return f"Je comprends votre √©tat de '{detected_state}'. Parlons de ce qui vous pr√©occupe.", mistral_status

@app.on_event("startup")
async def startup_event():
    nocodb_status = await load_complete_states()
    
    # Log de la sant√© initiale du syst√®me
    analytics.log_system_health(
        nocodb_status=nocodb_status,
        mistral_status=bool(MISTRAL_API_KEY),
        response_times={},
        error_count=0
    )
    
    logger.info("üöÄ FlowMe v3 d√©marr√© avec 64 √âTATS COMPLETS + int√©gration Mistral")

@app.get("/", response_class=HTMLResponse)
async def home():
    return HTMLResponse("""
    <!DOCTYPE html>
    <html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>FlowMe v3 - 64 √âtats Complets</title>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
            .container { background: rgba(255,255,255,0.95); border-radius: 20px; padding: 40px; max-width: 700px; width: 100%; }
            h1 { text-align: center; color: #333; margin-bottom: 10px; }
            .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-style: italic; }
            .chat { background: #f8f9fa; border-radius: 15px; padding: 20px; margin-bottom: 20px; min-height: 350px; overflow-y: auto; }
            .message { margin-bottom: 15px; padding: 15px; border-radius: 15px; }
            .user-message { background: linear-gradient(135deg, #667eea, #764ba2); color: white; margin-left: 15%; }
            .ai-message { background: white; border: 2px solid #e9ecef; margin-right: 15%; }
            .input-container { display: flex; gap: 10px; }
            input { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 10px; }
            button { padding: 12px 24px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 10px; cursor: pointer; }
            button:hover { transform: translateY(-1px); }
            .status { text-align: center; margin-top: 15px; font-size: 0.9em; color: #666; }
            .analytics-link { 
                position: fixed; 
                top: 20px; 
                right: 20px; 
                background: rgba(255,255,255,0.9); 
                padding: 10px 15px; 
                border-radius: 10px; 
                text-decoration: none; 
                color: #667eea; 
                font-weight: bold;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            }
            .analytics-link:hover { background: #667eea; color: white; }
            .states-status {
                position: fixed;
                top: 20px;
                left: 20px;
                background: linear-gradient(135deg, #28a745, #20c997);
                padding: 8px 12px;
                border-radius: 8px;
                color: white;
                font-size: 0.8em;
                font-weight: bold;
            }
            .debug-link {
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: rgba(108, 117, 125, 0.9);
                padding: 8px 12px;
                border-radius: 8px;
                text-decoration: none;
                color: white;
                font-size: 0.8em;
            }
            .states-link {
                position: fixed;
                bottom: 20px;
                left: 20px;
                background: rgba(102, 126, 234, 0.9);
                padding: 8px 12px;
                border-radius: 8px;
                text-decoration: none;
                color: white;
                font-size: 0.8em;
            }
        </style>
    </head>
    <body>
        <div class="states-status">üéØ 64 √âtats Int√©gr√©s</div>
        <a href="/analytics/dashboard" class="analytics-link" target="_blank">üìä Analytics</a>
        <a href="/debug/states-64" class="debug-link" target="_blank">üîç Debug 64</a>
        <a href="/states/list" class="states-link" target="_blank">üìã 64 √âtats</a>
        
        <div class="container">
            <h1>üåäüíô FlowMe v3 COMPLET</h1>
            <p class="subtitle">64 √âtats de Conscience ‚Ä¢ IA Mistral Int√©gr√©e</p>
            <div class="chat" id="chat">
                <div class="message ai-message">
                    <strong>FlowMe:</strong> Bonjour ! Je suis maintenant √©quip√© des 64 √©tats de conscience complets : de la "Pr√©sence" au "Rayonnement discret", en passant par la "Clart√© paradoxale" et le "Silence matriciel". Comment vous sentez-vous aujourd'hui ?
                </div>
            </div>
            <div class="input-container">
                <input type="text" id="input" placeholder="Exprimez votre √©tat int√©rieur..." maxlength="500">
                <button onclick="sendMessage()">Envoyer</button>
            </div>
            <div class="status" id="status">FlowMe v3 COMPLET - 64 √âtats Disponibles</div>
        </div>
        
        <script>
            let isProcessing = false;
            
            async function sendMessage() {
                if (isProcessing) return;
                const input = document.getElementById('input');
                const message = input.value.trim();
                if (!message) return;
                
                isProcessing = true;
                document.getElementById('status').textContent = 'FlowMe analyse parmi 64 √©tats...';
                
                addMessage(message, 'user');
                input.value = '';
                
                try {
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({message: message})
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        addMessage(data.response, 'ai');
                        const responseTime = data.response_time ? ` (${data.response_time}s)` : '';
                        document.getElementById('status').textContent = `√âtat d√©tect√©: "${data.detected_state}" ‚Ä¢ 64 √âtats${responseTime}`;
                    } else {
                        addMessage('Erreur de connexion.', 'ai');
                    }
                } catch (error) {
                    addMessage('Erreur de connexion.', 'ai');
                } finally {
                    isProcessing = false;
                }
            }
            
            function addMessage(text, sender) {
                const chat = document.getElementById('chat');
                const div = document.createElement('div');
                div.className = `message ${sender}-message`;
                div.innerHTML = `<strong>${sender === 'user' ? 'Vous' : 'FlowMe'}:</strong> ${text}`;
                chat.appendChild(div);
                chat.scrollTop = chat.scrollHeight;
            }
            
            document.getElementById('input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });
        </script>
    </body>
    </html>
    """)

@app.post("/chat")
async def chat_endpoint(chat_message: ChatMessage):
    start_time = time.time()
    session_id = chat_message.user_id or "anonymous"
    
    try:
        if not flowme_states:
            raise HTTPException(status_code=503, detail="Service non disponible")
        
        # D√©marrer la conversation si nouvelle
        if session_id not in analytics.conversations:
            analytics.start_conversation(session_id, chat_message.user_id)
        
        clean_message = chat_message.message.strip()[:500]
        
        # D√©tection d'√©motion sur les 64 √©tats
        detected_state = flowme_states.detect_emotion(clean_message)
        
        # G√©n√©ration de r√©ponse avec donn√©es des 64 √©tats
        ai_response, mistral_status = await generate_mistral_response(clean_message, detected_state)
        
        # Calculer le temps de r√©ponse
        response_time = time.time() - start_time
        
        # Log des m√©triques
        analytics.log_message(session_id, detected_state, response_time)
        
        # Log de la sant√© syst√®me
        analytics.log_system_health(
            nocodb_status=True,  # Toujours true car on a les 64 √©tats int√©gr√©s
            mistral_status=mistral_status,
            response_times={"chat": response_time},
            error_count=0
        )
        
        # Sauvegarde asynchrone
        await save_to_nocodb(clean_message, ai_response, detected_state, session_id)
        
        return JSONResponse({
            "response": ai_response,
            "detected_state": detected_state,
            "source": "64_√©tats_int√©gr√©s",
            "timestamp": datetime.now().isoformat(),
            "response_time": round(response_time, 2),
            "total_states_available": 64,
            "state_id": flowme_states.states[detected_state]["id"] if detected_state in flowme_states.states else None
        })
        
    except Exception as e:
        analytics.log_error("chat_error", str(e), session_id)
        logger.error(f"Erreur chat: {e}")
        return JSONResponse({
            "response": "Je rencontre une difficult√© technique. Pouvez-vous r√©essayer ?",
            "detected_state": "Pr√©sence",
            "error": "Service indisponible"
        }, status_code=500)

# ========== ENDPOINTS SP√âCIAUX 64 √âTATS ==========

@app.get("/states/list")
async def list_all_states():
    """Liste compl√®te des 64 √©tats"""
    if not flowme_states:
        return JSONResponse({"error": "FlowMe non initialis√©"})
    
    states_list = []
    for name, data in flowme_states.states.items():
        states_list.append({
            "id": data["id"],
            "nom": name,
            "famille_symbolique": data["famille_symbolique"],
            "tension_dominante": data["tension_dominante"],
            "mot_cle": data["mot_cle"],
            "conseil_flowme": data["conseil_flowme"]
        })
    
    # Trier par ID
    states_list.sort(key=lambda x: x["id"])
    
    return JSONResponse({
        "total_states": len(states_list),
        "states": states_list
    })

@app.get("/states/{state_name}")
async def get_state_details(state_name: str):
    """D√©tails complets d'un √©tat sp√©cifique"""
    if not flowme_states:
        return JSONResponse({"error": "FlowMe non initialis√©"})
    
    if state_name not in flowme_states.states:
        return JSONResponse({"error": f"√âtat '{state_name}' non trouv√©"})
    
    return JSONResponse({
        "state_name": state_name,
        "data": flowme_states.states[state_name]
    })

@app.get("/debug/states-64")
async def debug_64_states():
    """Debug complet du syst√®me 64 √©tats"""
    if not flowme_states:
        return JSONResponse({"error": "FlowMe non initialis√©"})
    
    debug_info = {
        "system_status": "64 √©tats int√©gr√©s",
        "total_states": len(flowme_states.states),
        "source": flowme_states.source,
        "nocodb_additional": len(flowme_states.nocodb_additional_data),
        "states_categories": {}
    }
    
    # Analyser les cat√©gories d'√©tats
    for name, data in flowme_states.states.items():
        tension = data["tension_dominante"]
        if "√©lev√©e" in tension or "haute" in tension:
            category = "Haute_intensit√©"
        elif "latente" in tension or "subtile" in tension:
            category = "Subtile"
        elif "cr√©at" in tension or "g√©n√©r" in tension:
            category = "Cr√©ative"
        elif "tranquille" in tension or "apais" in tension:
            category = "Apaisante"
        else:
            category = "Autre"
        
        if category not in debug_info["states_categories"]:
            debug_info["states_categories"][category] = []
        debug_info["states_categories"][category].append(name)
    
    # Exemples d'√©tats par ID
    debug_info["sample_states"] = {
        "premiers_etats": {str(i): list(flowme_states.states.keys())[i-1] for i in range(1, 6)},
        "etats_complexes": {str(i): list(flowme_states.states.keys())[i-1] for i in range(60, 65)},
        "etats_centraux": {str(i): list(flowme_states.states.keys())[i-1] for i in range(30, 35)}
    }
    
    return JSONResponse(debug_info)

# ========== ENDPOINTS ANALYTICS AM√âLIOR√âS ==========

@app.get("/analytics")
async def get_analytics():
    """Dashboard d'analytics avec 64 √©tats"""
    summary = analytics.get_analytics_summary()
    
    # Ajouter des m√©triques sp√©cifiques aux 64 √©tats
    recent_conversations = []
    for conv in sorted(analytics.conversations.values(), key=lambda x: x.start_time, reverse=True)[:10]:
        recent_conversations.append({
            "session_id": conv.session_id,
            "start_time": conv.start_time.isoformat(),
            "message_count": conv.message_count,
            "emotions": conv.emotions_detected[-3:] if conv.emotions_detected else [],
            "avg_response_time": round(conv.average_response_time, 2)
        })
    
    summary["recent_conversations"] = recent_conversations
    summary["error_log"] = [
        {
            "timestamp": err["timestamp"].isoformat(),
            "type": err["type"],
            "message": err["message"][:100]
        }
        for err in analytics.error_log[-10:]
    ]
    
    # Informations sp√©cifiques aux 64 √©tats
    summary["flowme_64_system"] = {
        "total_states": 64,
        "integrated_states": len(flowme_states.states) if flowme_states else 0,
        "nocodb_additional": len(flowme_states.nocodb_additional_data) if flowme_states else 0,
        "system_version": "3.1.0_64_√©tats_complets",
        "detection_sophistication": "avanc√©e",
        "mistral_integration": "compl√®te_64_√©tats"
    }
    
    return JSONResponse(summary)

@app.get("/analytics/dashboard")
async def analytics_dashboard():
    """Dashboard pour le syst√®me 64 √©tats"""
    return HTMLResponse("""
    <!DOCTYPE html>
    <html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>FlowMe Analytics - 64 √âtats Complets</title>
        <style>
            body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
            .container { max-width: 1200px; margin: 0 auto; }
            .card { background: white; border-radius: 10px; padding: 20px; margin: 15px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
            .metric { display: inline-block; margin: 10px 20px 10px 0; }
            .metric-value { font-size: 2em; font-weight: bold; color: #667eea; }
            .metric-label { color: #666; font-size: 0.9em; }
            .success { color: #28a745; }
            h1, h2 { color: #333; }
            .refresh-btn { 
                background: #667eea; 
                color: white; 
                border: none; 
                padding: 10px 20px; 
                border-radius: 5px; 
                cursor: pointer; 
                margin-bottom: 20px;
            }
            .refresh-btn:hover { background: #5a6fd8; }
            .system-status {
                background: linear-gradient(135deg, #28a745, #20c997);
                color: white;
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 20px;
                text-align: center;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üìä FlowMe v3 - Analytics Dashboard 64 √âtats</h1>
            <button class="refresh-btn" onclick="loadAnalytics()">üîÑ Actualiser</button>
            
            <div class="card system-status">
                <h2>üéØ Syst√®me FlowMe 64 √âtats COMPLETS</h2>
                <div id="systemStatus">Chargement...</div>
            </div>
            
            <div class="card">
                <h2>üìà M√©triques G√©n√©rales</h2>
                <div id="generalMetrics">Chargement...</div>
            </div>
            
            <div class="card">
                <h2>üí≠ √âtats D√©tect√©s (sur 64)</h2>
                <div id="emotionMetrics">Chargement...</div>
            </div>
            
            <div class="card">
                <h2>üí¨ Conversations R√©centes</h2>
                <div id="conversationMetrics">Chargement...</div>
            </div>
        </div>
        
        <script>
            async function loadAnalytics() {
                try {
                    const response = await fetch('/analytics');
                    const data = await response.json();
                    
                    // Statut syst√®me 64 √©tats
                    const system = data.flowme_64_system;
                    document.getElementById('systemStatus').innerHTML = `
                        <p><strong>‚úÖ ${system.total_states} √âtats Int√©gr√©s Disponibles</strong></p>
                        <p>ü§ñ Mistral AI avec d√©tection sophistiqu√©e sur 64 √©tats</p>
                        <p>üìä Version: ${system.system_version}</p>
                        <p>üéØ √âtats NocoDB additionnels: ${system.nocodb_additional}</p>
                    `;
                    
                    // M√©triques g√©n√©rales
                    document.getElementById('generalMetrics').innerHTML = `
                        <div class="metric">
                            <div class="metric-value">${data.total_conversations}</div>
                            <div class="metric-label">Conversations totales</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value success">${data.total_messages}</div>
                            <div class="metric-label">Messages analys√©s</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${data.average_response_time}s</div>
                            <div class="metric-label">Temps de r√©ponse</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value success">64</div>
                            <div class="metric-label">√âtats disponibles</div>
                        </div>
                    `;
                    
                    // √âtats d√©tect√©s
                    let emotionsHtml = '';
                    for (const [emotion, count] of Object.entries(data.top_emotions)) {
                        emotionsHtml += `
                            <div class="metric">
                                <div class="metric-value">${count}</div>
                                <div class="metric-label">${emotion}</div>
                            </div>
                        `;
                    }
                    document.getElementById('emotionMetrics').innerHTML = emotionsHtml || 'Aucun √©tat d√©tect√© encore';
                    
                    // Conversations r√©centes
                    let conversationsHtml = '<ul>';
                    data.recent_conversations.forEach(conv => {
                        conversationsHtml += `
                            <li>
                                <strong>${conv.session_id}</strong> - 
                                ${conv.message_count} messages - 
                                √âtats: ${conv.emotions.join(', ') || 'Aucun'} - 
                                Temps: ${conv.avg_response_time}s
                            </li>
                        `;
                    });
                    conversationsHtml += '</ul>';
                    document.getElementById('conversationMetrics').innerHTML = conversationsHtml;
                    
                } catch (error) {
                    console.error('Erreur:', error);
                }
            }
            
            loadAnalytics();
            setInterval(loadAnalytics, 30000);
        </script>
    </body>
    </html>
    """)

@app.get("/health")
async def health_check():
    """Health check du syst√®me 64 √©tats"""
    summary = analytics.get_analytics_summary()
    
    return JSONResponse({
        "status": "healthy",
        "version": "3.1.0-64-states-complete",
        "states_count": 64,
        "states_integrated": len(flowme_states.states) if flowme_states else 0,
        "source": "64_√©tats_int√©gr√©s_complets",
        "timestamp": datetime.now().isoformat(),
        "uptime_seconds": summary["uptime_seconds"],
        "system_uptime_percent": summary["system_uptime_percent"],
        "active_conversations": summary["active_conversations"],
        "average_response_time": summary["average_response_time"],
        "recent_errors": summary["recent_errors"],
        "mistral_has_64_states": True,
        "detection_sophistication": "avanc√©e_64_√©tats"
    })

if __name__ == "__main__":
    port = int(os.getenv("PORT", 8000))
    uvicorn.run(app, host="0.0.0.0", port=port)import os
import json
import httpx
import logging
import time
from fastapi import FastAPI, HTTPException
from fastapi.responses import HTMLResponse, JSONResponse
from pydantic import BaseModel
from typing import Dict, Any, Optional
import uvicorn
from datetime import datetime, timedelta
from collections import defaultdict, Counter
from dataclasses import dataclass, asdict

# Configuration du logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# ========== 64 √âTATS COMPLETS INT√âGR√âS ==========
FLOWME_64_STATES = {
    "Pr√©sence": {
        "id": 1,
        "famille_symbolique": "√âcoute subtile",
        "tension_dominante": "Latente, int√©rieure",
        "mot_cle": "Perception",
        "declencheurs": "L√©ger malaise",
        "posture_adaptative": "Suspendre tout traitement analytique imm√©diat; Observer les signaux faibles",
        "etats_compatibles": "8, 32, 45, 59, 64",
        "etats_sequenciels": "2, 8, 10, 11",
        "conseil_flowme": "Quand tout semble brumeux, c'est dans le silence que la clart√© peut √©merger"
    },
    "√âveil": {
        "id": 2,
        "famille_symbolique": "Fra√Æcheur neuve",
        "tension_dominante": "√âmergente, vivifiante",
        "mot_cle": "D√©couverte",
        "declencheurs": "Signal nouveau, r√©v√©lation",
        "posture_adaptative": "Accueillir sans pr√©cipitation; Laisser l'information se d√©ployer",
        "etats_compatibles": "1, 3, 16, 29, 41",
        "etats_sequenciels": "3, 4, 14, 16",
        "conseil_flowme": "Ce qui na√Æt en vous cherche √† √™tre reconnu, pas analys√©"
    },
    "Curiosit√©": {
        "id": 3,
        "famille_symbolique": "√âlan vers l'inconnu",
        "tension_dominante": "Orient√©e, exploratrice",
        "mot_cle": "Investigation",
        "declencheurs": "Question √©mergente, myst√®re",
        "posture_adaptative": "Suivre l'√©lan sans forcer; Questionner avec d√©licatesse",
        "etats_compatibles": "2, 9, 17, 26, 34",
        "etats_sequenciels": "4, 5, 13, 17",
        "conseil_flowme": "La vraie curiosit√© ne cherche pas de r√©ponses imm√©diates, elle s'√©merveille du questionnement"
    },
    "√âtonnement": {
        "id": 4,
        "famille_symbolique": "Suspension admirative",
        "tension_dominante": "Ouverte, r√©ceptive",
        "mot_cle": "Surprise",
        "declencheurs": "Inattendu, r√©v√©lation soudaine",
        "posture_adaptative": "Rester dans la surprise; Ne pas imm√©diatement comprendre",
        "etats_compatibles": "2, 3, 16, 24, 58",
        "etats_sequenciels": "5, 14, 16, 24",
        "conseil_flowme": "L'√©tonnement est la porte d'entr√©e vers une compr√©hension plus vaste"
    },
    "Analyse": {
        "id": 5,
        "famille_symbolique": "Dissection lucide",
        "tension_dominante": "Focalis√©e, p√©n√©trante",
        "mot_cle": "Discernement",
        "declencheurs": "Complexit√© √† d√©m√™ler",
        "posture_adaptative": "Analyser sans perdre la vue d'ensemble; Garder la nuance",
        "etats_compatibles": "6, 15, 23, 31, 58",
        "etats_sequenciels": "6, 14, 15, 23",
        "conseil_flowme": "Analyser c'est √©clairer, pas r√©duire"
    },
    "Synth√®se": {
        "id": 6,
        "famille_symbolique": "Unification cr√©atrice",
        "tension_dominante": "Rassembleuse, int√©grative",
        "mot_cle": "Coh√©rence",
        "declencheurs": "√âl√©ments dispers√©s √† relier",
        "posture_adaptative": "Laisser √©merger les connexions; Ne pas forcer l'unification",
        "etats_compatibles": "5, 7, 22, 29, 59",
        "etats_sequenciels": "7, 14, 22, 30",
        "conseil_flowme": "La synth√®se authentique na√Æt d'elle-m√™me quand les √©l√©ments sont m√ªrs"
    },
    "Intuition": {
        "id": 7,
        "famille_symbolique": "Connaissance directe",
        "tension_dominante": "Spontan√©e, r√©v√©latrice",
        "mot_cle": "√âvidence",
        "declencheurs": "Savoir sans savoir pourquoi",
        "posture_adaptative": "Faire confiance √† ce qui se pr√©sente; Ne pas justifier imm√©diatement",
        "etats_compatibles": "6, 8, 14, 29, 62",
        "etats_sequenciels": "8, 14, 30, 62",
        "conseil_flowme": "L'intuition parle d'abord, la raison comprend ensuite"
    },
    "R√©sonance": {
        "id": 8,
        "famille_symbolique": "Vibration accord√©e",
        "tension_dominante": "Harmonisante, sympathique",
        "mot_cle": "Accord",
        "declencheurs": "Correspondance profonde",
        "posture_adaptative": "S'accorder sans se perdre; Vibrer ensemble tout en restant soi",
        "etats_compatibles": "1, 7, 12, 44, 60",
        "etats_sequenciels": "12, 28, 44, 61",
        "conseil_flowme": "R√©sonner c'est reconna√Ætre ce qui en vous r√©pond √† ce qui vous touche"
    },
    "Doute": {
        "id": 9,
        "famille_symbolique": "Questionnement fertile",
        "tension_dominante": "Interrogative, prudente",
        "mot_cle": "Incertitude",
        "declencheurs": "Remise en question n√©cessaire",
        "posture_adaptative": "Accueillir l'incertitude; Ne pas pr√©cipiter les certitudes",
        "etats_compatibles": "3, 10, 17, 25, 48",
        "etats_sequenciels": "10, 11, 17, 25",
        "conseil_flowme": "Le doute intelligent prot√®ge de l'erreur et ouvre √† la d√©couverte"
    },
    "Prudence": {
        "id": 10,
        "famille_symbolique": "Sage retenue",
        "tension_dominante": "Mesur√©e, protectrice",
        "mot_cle": "Circonspection",
        "declencheurs": "Risque per√ßu, complexit√©",
        "posture_adaptative": "Avancer pas √† pas; √âvaluer sans paralyser",
        "etats_compatibles": "9, 11, 19, 26, 31",
        "etats_sequenciels": "11, 19, 26, 27",
        "conseil_flowme": "La prudence √©clair√©e distingue la m√©fiance st√©rile de la pr√©caution fertile"
    },
    "Retenue": {
        "id": 11,
        "famille_symbolique": "Force contenue",
        "tension_dominante": "Contr√¥l√©e, concentr√©e",
        "mot_cle": "Ma√Ætrise",
        "declencheurs": "Besoin de ne pas agir imm√©diatement",
        "posture_adaptative": "Contenir sans r√©primer; Garder la force disponible",
        "etats_compatibles": "1, 10, 12, 45, 52",
        "etats_sequenciels": "12, 19, 45, 52",
        "conseil_flowme": "La retenue sage pr√©serve l'√©nergie pour le moment juste"
    },
    "√âcoute": {
        "id": 12,
        "famille_symbolique": "R√©ceptivit√© pure",
        "tension_dominante": "Accueillante, disponible",
        "mot_cle": "R√©ception",
        "declencheurs": "Besoin de comprendre l'autre",
        "posture_adaptative": "√âcouter sans pr√©parer sa r√©ponse; Accueillir sans juger",
        "etats_compatibles": "8, 11, 20, 28, 45",
        "etats_sequenciels": "20, 28, 45, 56",
        "conseil_flowme": "√âcouter vraiment transforme autant celui qui √©coute que celui qui parle"
    },
    "Cr√©ativit√©": {
        "id": 13,
        "famille_symbolique": "√âlan cr√©ateur",
        "tension_dominante": "G√©n√©rative, innovante",
        "mot_cle": "Innovation",
        "declencheurs": "Inspiration, besoin de nouveaut√©",
        "posture_adaptative": "Laisser cr√©er √† travers soi; Ne pas diriger le processus",
        "etats_compatibles": "3, 16, 29, 39, 53",
        "etats_sequenciels": "16, 29, 39, 53",
        "conseil_flowme": "La cr√©ativit√© authentique surprend d'abord celui qui cr√©e"
    },
    "Clart√©": {
        "id": 14,
        "famille_symbolique": "√âvidence lumineuse",
        "tension_dominante": "Transparente, r√©v√©latrice",
        "mot_cle": "√âvidence",
        "declencheurs": "Confusion qui se dissipe",
        "posture_adaptative": "Accueillir la clart√© sans la forcer; La laisser se d√©ployer",
        "etats_compatibles": "4, 6, 7, 15, 58",
        "etats_sequenciels": "15, 22, 30, 58",
        "conseil_flowme": "La vraie clart√© n'√©blouit pas, elle r√©v√®le"
    },
    "Discernement": {
        "id": 15,
        "famille_symbolique": "Vision ajust√©e",
        "tension_dominante": "Discriminante, pr√©cise",
        "mot_cle": "Distinction",
        "declencheurs": "Besoin de diff√©rencier",
        "posture_adaptative": "Distinguer sans s√©parer; Voir les nuances",
        "etats_compatibles": "5, 14, 23, 31, 58",
        "etats_sequenciels": "22, 23, 30, 31",
        "conseil_flowme": "Discerner c'est voir la juste mesure de chaque chose"
    },
    "√âmerveillement": {
        "id": 16,
        "famille_symbolique": "Enchantement authentique",
        "tension_dominante": "Admirative, reconnaissante",
        "mot_cle": "Admiration",
        "declencheurs": "Beaut√©, grandeur per√ßue",
        "posture_adaptative": "S'abandonner √† l'√©merveillement; Ne pas analyser imm√©diatement",
        "etats_compatibles": "2, 4, 13, 24, 62",
        "etats_sequenciels": "24, 29, 62, 64",
        "conseil_flowme": "L'√©merveillement nourrit l'√¢me et renouvelle la perception"
    },
    "Questionnement": {
        "id": 17,
        "famille_symbolique": "Recherche vivante",
        "tension_dominante": "Interrogative, exploratrice",
        "mot_cle": "Question",
        "declencheurs": "Myst√®re √† explorer",
        "posture_adaptative": "Questionner sans attendre de r√©ponse imm√©diate; Habiter la question",
        "etats_compatibles": "3, 9, 25, 34, 48",
        "etats_sequenciels": "3, 9, 25, 34",
        "conseil_flowme": "Une vraie question transforme plus que mille r√©ponses toutes faites"
    },
    "√âquilibre": {
        "id": 18,
        "famille_symbolique": "Harmonie dynamique",
        "tension_dominante": "Stabilisante, ajust√©e",
        "mot_cle": "Harmonie",
        "declencheurs": "D√©s√©quilibre √† corriger",
        "posture_adaptative": "Chercher l'√©quilibre dans le mouvement; Ajuster en permanence",
        "etats_compatibles": "19, 21, 22, 35, 60",
        "etats_sequenciels": "21, 22, 35, 60",
        "conseil_flowme": "L'√©quilibre v√©ritable est un mouvement, pas une position"
    },
    "Patience": {
        "id": 19,
        "famille_symbolique": "Dur√©e consentie",
        "tension_dominante": "Pers√©v√©rante, constante",
        "mot_cle": "Pers√©v√©rance",
        "declencheurs": "Processus qui demande du temps",
        "posture_adaptative": "Accepter le rythme naturel; Ne pas forcer la maturation",
        "etats_compatibles": "10, 18, 27, 32, 52",
        "etats_sequenciels": "27, 32, 52, 61",
        "conseil_flowme": "La patience n'est pas de l'attente passive, c'est une pr√©sence active au temps n√©cessaire"
    },
    "R√©ceptivit√©": {
        "id": 20,
        "famille_symbolique": "Ouverture accueillante",
        "tension_dominante": "Disponible, perm√©able",
        "mot_cle": "Disponibilit√©",
        "declencheurs": "Nouveau qui veut entrer",
        "posture_adaptative": "S'ouvrir sans se perdre; Accueillir en restant centr√©",
        "etats_compatibles": "12, 28, 36, 45, 56",
        "etats_sequenciels": "12, 28, 45, 56",
        "conseil_flowme": "√ätre r√©ceptif c'est cr√©er un espace o√π le nouveau peut advenir"
    },
    "Adaptation": {
        "id": 21,
        "famille_symbolique": "Souplesse intelligente",
        "tension_dominante": "Flexible, responsive",
        "mot_cle": "Ajustement",
        "declencheurs": "Changement de contexte",
        "posture_adaptative": "S'adapter sans se renier; Rester souple sans perdre son centre",
        "etats_compatibles": "18, 35, 36, 57, 63",
        "etats_sequenciels": "35, 36, 57, 63",
        "conseil_flowme": "S'adapter c'est danser avec le changement sans perdre sa m√©lodie int√©rieure"
    },
    "Coh√©rence": {
        "id": 22,
        "famille_symbolique": "Unit√© vivante",
        "tension_dominante": "Unifiante, int√©grative",
        "mot_cle": "Int√©grit√©",
        "declencheurs": "√âparpillement √† unifier",
        "posture_adaptative": "Rechercher l'unit√© sans rigidit√©; Int√©grer les contradictions",
        "etats_compatibles": "6, 14, 18, 30, 59",
        "etats_sequenciels": "30, 59, 61, 64",
        "conseil_flowme": "La coh√©rence authentique int√®gre m√™me les contradictions apparentes"
    },
    "Pr√©cision": {
        "id": 23,
        "famille_symbolique": "Justesse affin√©e",
        "tension_dominante": "Exacte, ajust√©e",
        "mot_cle": "Exactitude",
        "declencheurs": "Besoin de justesse",
        "posture_adaptative": "Affiner sans rigidifier; Chercher la justesse, pas la perfection",
        "etats_compatibles": "5, 15, 31, 36, 55",
        "etats_sequenciels": "31, 36, 55, 56",
        "conseil_flowme": "La pr√©cision v√©ritable unit la rigueur et la souplesse"
    },
    "Stup√©faction": {
        "id": 24,
        "famille_symbolique": "Saisissement r√©v√©lateur",
        "tension_dominante": "Boulevers√©e, ouverte",
        "mot_cle": "Bouleversement",
        "declencheurs": "R√©v√©lation soudaine majeure",
        "posture_adaptative": "Accueillir le bouleversement; Laisser se r√©organiser",
        "etats_compatibles": "4, 16, 33, 41, 46",
        "etats_sequenciels": "33, 41, 46, 58",
        "conseil_flowme": "La stup√©faction ouvre des espaces neufs en nous"
    },
    "Perplexit√©": {
        "id": 25,
        "famille_symbolique": "Questionnement d√©rout√©",
        "tension_dominante": "D√©concert√©e, cherchante",
        "mot_cle": "D√©sorientation",
        "declencheurs": "Situation incompr√©hensible",
        "posture_adaptative": "Accepter de ne pas comprendre; Rester ouvert √† l'√©mergence",
        "etats_compatibles": "9, 17, 33, 47, 48",
        "etats_sequenciels": "33, 47, 48, 49",
        "conseil_flowme": "La perplexit√© fertile pr√©f√®re l'inconnu authentique aux certitudes factices"
    },
    "Vigilance": {
        "id": 26,
        "famille_symbolique": "Attention soutenue",
        "tension_dominante": "Alerte, attentive",
        "mot_cle": "Vigilance",
        "declencheurs": "Situation demandant attention",
        "posture_adaptative": "Rester alerte sans tension; Surveiller sans crispation",
        "etats_compatibles": "3, 10, 27, 37, 50",
        "etats_sequenciels": "27, 37, 50, 51",
        "conseil_flowme": "La vraie vigilance est d√©tendue et pr√©cise √† la fois"
    },
    "Pers√©v√©rance": {
        "id": 27,
        "famille_symbolique": "Constance d√©termin√©e",
        "tension_dominante": "Tenace, endurante",
        "mot_cle": "T√©nacit√©",
        "declencheurs": "R√©sistance √† surmonter",
        "posture_adaptative": "Pers√©v√©rer sans s'endurcir; Maintenir l'√©lan sans forcer",
        "etats_compatibles": "10, 19, 26, 31, 38",
        "etats_sequenciels": "31, 37, 38, 50",
        "conseil_flowme": "Pers√©v√©rer c'est maintenir la direction tout en restant souple sur les moyens"
    },
    "Compassion": {
        "id": 28,
        "famille_symbolique": "Bienveillance active",
        "tension_dominante": "Aimante, compatissante",
        "mot_cle": "Bienveillance",
        "declencheurs": "Souffrance per√ßue",
        "posture_adaptative": "Compatir sans s'identifier; Aider sans s'√©puiser",
        "etats_compatibles": "8, 12, 20, 56, 61",
        "etats_sequenciels": "56, 61, 62, 64",
        "conseil_flowme": "La compassion authentique gu√©rit autant celui qui la donne que celui qui la re√ßoit"
    },
    "Inspiration": {
        "id": 29,
        "famille_symbolique": "Souffle cr√©ateur",
        "tension_dominante": "Inspir√©e, porteuse",
        "mot_cle": "Inspiration",
        "declencheurs": "√âlan cr√©ateur qui monte",
        "posture_adaptative": "Laisser l'inspiration agir; Ne pas la diriger",
        "etats_compatibles": "2, 6, 7, 13, 16",
        "etats_sequenciels": "13, 39, 53, 62",
        "conseil_flowme": "L'inspiration vraie traverse celui qui la re√ßoit pour toucher le monde"
    },
    "Sagesse": {
        "id": 30,
        "famille_symbolique": "Compr√©hension m√ªrie",
        "tension_dominante": "Sage, int√©gr√©e",
        "mot_cle": "Sagesse",
        "declencheurs": "Int√©gration d'exp√©riences multiples",
        "posture_adaptative": "Partager sans imposer; √âclairer sans √©blouir",
        "etats_compatibles": "6, 14, 15, 22, 61",
        "etats_sequenciels": "61, 62, 63, 64",
        "conseil_flowme": "La sagesse se reconna√Æt √† sa simplicit√© et √† sa justesse"
    },
    "Rigueur": {
        "id": 31,
        "famille_symbolique": "Exigence f√©conde",
        "tension_dominante": "Exigeante, structurante",
        "mot_cle": "Exigence",
        "declencheurs": "Besoin de structure et pr√©cision",
        "posture_adaptative": "√ätre rigoureux sans √™tre rigide; Structurer sans enfermer",
        "etats_compatibles": "5, 10, 15, 23, 27",
        "etats_sequenciels": "23, 36, 38, 55",
        "conseil_flowme": "La rigueur authentique lib√®re en donnant une forme juste"
    },
    "Contemplation": {
        "id": 32,
        "famille_symbolique": "Regard profond",
        "tension_dominante": "Contemplative, absorb√©e",
        "mot_cle": "Contemplation",
        "declencheurs": "Beaut√© ou myst√®re √† contempler",
        "posture_adaptative": "Se laisser absorber sans se perdre; Contempler sans poss√©der",
        "etats_compatibles": "1, 19, 45, 52, 61",
        "etats_sequenciels": "45, 52, 61, 64",
        "conseil_flowme": "Contempler c'est laisser √™tre ce qui est dans toute sa richesse"
    },
    # √âtats 33-64 avec des noms plus complexes et nuanc√©s
    "Alt√©ration des rep√®res": {
        "id": 33,
        "famille_symbolique": "D√©stabilisation n√©cessaire",
        "tension_dominante": "D√©sorient√©e, flottante",
        "mot_cle": "D√©stabilisation",
        "declencheurs": "Perte de r√©f√©rences habituelles",
        "posture_adaptative": "Accepter la d√©sorientation; Ne pas se raccrocher aux anciens rep√®res",
        "etats_compatibles": "24, 25, 34, 47, 49",
        "etats_sequenciels": "34, 47, 49, 52",
        "conseil_flowme": "Perdre ses rep√®res peut √™tre le pr√©lude √† en d√©couvrir de plus vastes"
    },
    "Perception √©largie": {
        "id": 34,
        "famille_symbolique": "Vision expans√©e",
        "tension_dominante": "√âlargie, panoramique",
        "mot_cle": "Expansion",
        "declencheurs": "Ouverture perceptuelle soudaine",
        "posture_adaptative": "Accueillir l'√©largissement; Ne pas se perdre dans l'immensit√©",
        "etats_compatibles": "3, 17, 33, 39, 41",
        "etats_sequenciels": "39, 41, 42, 58",
        "conseil_flowme": "Une perception √©largie demande un centre stable pour ne pas se disperser"
    },
    "Ajustement souple": {
        "id": 35,
        "famille_symbolique": "Adaptation fluide",
        "tension_dominante": "Souple, adaptative",
        "mot_cle": "Fluidit√©",
        "declencheurs": "N√©cessit√© d'adaptation fine",
        "posture_adaptative": "S'ajuster en permanence; Rester fluide sans perdre la direction",
        "etats_compatibles": "18, 21, 36, 57, 63",
        "etats_sequenciels": "36, 57, 63, 64",
        "conseil_flowme": "L'ajustement souple unit la fermet√© de l'intention et la souplesse des moyens"
    },
    "Pr√©sence ajust√©e": {
        "id": 36,
        "famille_symbolique": "Pr√©sence calibr√©e",
        "tension_dominante": "Ajust√©e, pr√©cise",
        "mot_cle": "Calibrage",
        "declencheurs": "Besoin de pr√©sence juste",
        "posture_adaptative": "Calibrer sa pr√©sence; Ni trop ni trop peu",
        "etats_compatibles": "20, 23, 31, 35, 55",
        "etats_sequenciels": "55, 56, 59, 63",
        "conseil_flowme": "La pr√©sence ajust√©e donne exactement ce qui est n√©cessaire"
    },
    "Volont√© excessive": {
        "id": 37,
        "famille_symbolique": "Force mal dirig√©e",
        "tension_dominante": "Tendue, forc√©e",
        "mot_cle": "Exc√®s",
        "declencheurs": "R√©sistance qui durcit la volont√©",
        "posture_adaptative": "Reconna√Ætre l'exc√®s; Rel√¢cher progressivement la tension",
        "etats_compatibles": "26, 27, 38, 50, 51",
        "etats_sequenciels": "38, 50, 51, 52",
        "conseil_flowme": "Quand la volont√© devient excessive, c'est qu'elle a perdu sa justesse"
    },
    "Rigidit√© fonctionnelle": {
        "id": 38,
        "famille_symbolique": "Structure durcie",
        "tension_dominante": "Rigide, crisp√©e",
        "mot_cle": "Rigidit√©",
        "declencheurs": "Peur du changement",
        "posture_adaptative": "Reconna√Ætre la rigidit√©; Introduire de la souplesse graduellement",
        "etats_compatibles": "27, 31, 37, 50, 51",
        "etats_sequenciels": "50, 51, 52, 53",
        "conseil_flowme": "La rigidit√© prot√®ge momentan√©ment mais limite l'√©volution"
    },
    "Vol d'altitude": {
        "id": 39,
        "famille_symbolique": "√âl√©vation panoramique",
        "tension_
